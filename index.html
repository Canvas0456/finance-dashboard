<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Kaiwalya‚Äôs Finance Dashboard</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<style>
:root {
  --bg-main: #0f1115;
  --bg-card: rgba(255,255,255,0.06);
  --bg-glass: rgba(255,255,255,0.08);
  --border-soft: rgba(255,255,255,0.12);
  --text-main: #f5f6f7;
  --text-muted: #9aa0a6;
  --accent-blue: #5b8cff;
  --accent-green: #4cd964;
  --accent-orange: #ff9f0a;
  --accent-red: #ff453a;
  --radius-lg: 18px;
  --radius-md: 14px;
}

* {
  box-sizing: border-box;
  font-family: 'Inter', sans-serif;
}

body {
  margin: 0;
  background: radial-gradient(circle at top, #1a1f2b, #0f1115 60%);
  color: var(--text-main);
  min-height: 100vh;
}

/* ===== Fixed Header ===== */
.app-header {
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(14px);
  background: linear-gradient(
    to bottom,
    rgba(15,17,21,0.85),
    rgba(15,17,21,0.65)
  );
  border-bottom: 1px solid var(--border-soft);
}

.header-inner {
  max-width: 1200px;
  margin: auto;
  padding: 18px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.header-left h1 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
}

.header-left p {
  margin: 4px 0 0;
  font-size: 13px;
  color: var(--text-muted);
}

.header-right {
  text-align: right;
  font-size: 13px;
}

.header-date {
  font-weight: 500;
}

.header-period {
  margin-top: 4px;
  color: var(--accent-blue);
  font-weight: 500;
}

/* ===== Page Wrapper ===== */
.app-container {
  max-width: 1200px;
  margin: auto;
  padding: 24px 20px 120px;
}

/* ===== Utility ===== */
.glass {
  background: var(--bg-card);
  border: 1px solid var(--border-soft);
  border-radius: var(--radius-lg);
  backdrop-filter: blur(14px);
}

.section {
  margin-top: 26px;
}

.section-title {
  font-size: 16px;
  font-weight: 600;
  margin-bottom: 14px;
}

.fade-in {
  animation: fadeIn 0.6s ease forwards;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
</head>

<body>

<!-- ================= HEADER ================= -->
<header class="app-header">
  <div class="header-inner">
    <div class="header-left">
      <h1>Kaiwalya‚Äôs Finance Dashboard</h1>
      <p>Clarity over cash. Control over chaos.</p>
    </div>

    <div class="header-right">
      <div class="header-date" id="todayDate">‚Äî</div>
      <div class="header-period" id="selectedPeriod">MONTH ¬∑ ‚Äî</div>
    </div>
  </div>
</header>

<!-- ================= APP CONTENT START ================= -->
<div class="app-container">
  
<script>
/* ===============================
   GOOGLE SHEETS CONFIG
================================ */
const SHEET_ID = "1ApiV5dmKYycVw2IEnVKkNHY2ssLcOZZ1v1slU57UqM0";
const SHEET_BASE = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?`;

/* ===============================
   GLOBAL STATE
================================ */
let VIEW_MODE = "MONTH"; // MONTH | YTD
let CURRENT_MONTH = new Date();

/* ===============================
   DATE HELPERS
================================ */
function formatDateHuman(date) {
  return date.toLocaleDateString("en-IN", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
}

function formatMonthYYYYMM(date) {
  return date.toISOString().slice(0,7);
}

function formatMonthMMMMYYYY(date) {
  return date.toLocaleDateString("en-IN", {
    month: "long",
    year: "numeric"
  });
}

/* ===============================
   HEADER INIT
================================ */
document.getElementById("todayDate").innerText =
  formatDateHuman(new Date());

document.getElementById("selectedPeriod").innerText =
  `MONTH ¬∑ ${formatMonthMMMMYYYY(CURRENT_MONTH)}`;

/* ===============================
   CORE FETCH ENGINE
================================ */
async function fetchSheet(sheetName, query = "SELECT *") {
  const url =
    SHEET_BASE +
    `sheet=${encodeURIComponent(sheetName)}` +
    `&tq=${encodeURIComponent(query)}`;

  const res = await fetch(url);
  const text = await res.text();

  const json = JSON.parse(
    text.substring(text.indexOf("{"), text.lastIndexOf("}") + 1)
  );

  const cols = json.table.cols.map(c => c.label);
  const rows = json.table.rows.map(r =>
    r.c.map(c => (c ? c.v : null))
  );

  return rows.map(row =>
    Object.fromEntries(row.map((val, i) => [cols[i], val]))
  );
}

/* ===============================
   SAFE NUMBER FORMAT
================================ */
function money(val) {
  if (val === null || isNaN(val)) return "‚Çπ0";
  return "‚Çπ" + Math.round(val).toLocaleString("en-IN");
}

/* ===============================
   MONTH / YTD TOGGLE HANDLER
================================ */
function setViewMode(mode) {
  VIEW_MODE = mode;

  document.getElementById("selectedPeriod").innerText =
    mode === "MONTH"
      ? `MONTH ¬∑ ${formatMonthMMMMYYYY(CURRENT_MONTH)}`
      : `YTD ¬∑ ${CURRENT_MONTH.getFullYear()}`;

  refreshDashboard();
}

/* ===============================
   DASHBOARD REFRESH (MASTER)
================================ */
async function refreshDashboard() {
  console.log("Refreshing dashboard:", VIEW_MODE);

  await loadKPIs();
  await loadBudgetBar();
  await loadExpenseTrend();
  await loadEMIs();
}

/* ===============================
   INITIAL LOAD
================================ */
refreshDashboard();
</script>

  <script>
/* ===============================
   KPI LOADERS
================================ */

async function loadKPIs() {
  const kpis = await fetchSheet("Dashboard_KPIs");

  const map = {};
  kpis.forEach(k => map[k.KPI] = k.Value);

  /* TOTAL BALANCE */
  document.getElementById("kpi-balance").innerText =
    money(map["Total Balance (All Accounts)"]);

  /* TOTAL EXPENSES */
  document.getElementById("kpi-expense").innerText =
    money(map["Current Month Expenses"]);

  /* BUDGET BURN % */
  const burn = Number(map["Budget Used %"]) || 0;
  const burnPct = (burn * 100).toFixed(1);

  document.getElementById("kpi-burn").innerText =
    burnPct + "%";

  /* BUDGET REMAINING */
  document.getElementById("kpi-remaining").innerText =
    money(map["Budget Remaining"]);
}

/* ===============================
   BUDGET UTILISATION BAR
================================ */
async function loadBudgetBar() {
  const rows = await fetchSheet("Budget_vs_Actual");

  const currentMonth = formatMonthYYYYMM(CURRENT_MONTH);

  let budget = 0;
  let actual = 0;

  rows.forEach(r => {
    if (
      VIEW_MODE === "MONTH" &&
      r.Month === currentMonth
    ) {
      budget += Number(r.Budget_Amount || 0);
      actual += Number(r.Actual_Amount || 0);
    }

    if (
      VIEW_MODE === "YTD" &&
      r.Month.startsWith(CURRENT_MONTH.getFullYear())
    ) {
      budget += Number(r.Budget_Amount || 0);
      actual += Number(r.Actual_Amount || 0);
    }
  });

  const usedPct = budget === 0 ? 0 : (actual / budget) * 100;
  const remaining = Math.max(budget - actual, 0);

  document.getElementById("budgetUsedText").innerText =
    `Used ${usedPct.toFixed(1)}%`;

  document.getElementById("budgetRemainText").innerText =
    `Remaining ${money(remaining)}`;

  document.getElementById("budgetBarFill").style.width =
    Math.min(usedPct, 100) + "%";
}
  </script>
<!-- ===============================
     EXPENSE TREND SECTION
================================ -->
<section class="card">
  <h3 class="section-title">Expense Trend</h3>
  <canvas id="expenseTrend" height="140"></canvas>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let expenseChart;

/* ===============================
   LOAD EXPENSE TREND
================================ */
async function loadExpenseTrend() {
  const txns = await fetchSheet("Txn_Clean");

  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();

  let labels = [];
  let actuals = [];
  let forecast = [];

  if (VIEW_MODE === "MONTH") {
    /* -------- WEEKLY (CURRENT MONTH) -------- */
    const weekly = {};

    txns.forEach(t => {
      if (!t.Txn_Date) return;

      const d = new Date(t.Txn_Date);
      if (d.getFullYear() !== year || d.getMonth() !== month) return;
      if (Number(t.Signed_Amount) >= 0) return;

      const week = getWeekOfMonth(d);
      weekly[week] = (weekly[week] || 0) + Math.abs(Number(t.Signed_Amount));
    });

    labels = Object.keys(weekly).map(w => "W" + w);
    actuals = Object.values(weekly);
  }

  if (VIEW_MODE === "YTD") {
    /* -------- MONTHLY YTD -------- */
    const monthly = {};

    txns.forEach(t => {
      if (!t.Txn_Date) return;

      const d = new Date(t.Txn_Date);
      if (d > today) return;
      if (Number(t.Signed_Amount) >= 0) return;

      const key = d.getFullYear() + "-" + String(d.getMonth() + 1).padStart(2, "0");
      monthly[key] = (monthly[key] || 0) + Math.abs(Number(t.Signed_Amount));
    });

    labels = Object.keys(monthly);
    actuals = Object.values(monthly);

    /* -------- SIMPLE FORECAST -------- */
    const avg =
      actuals.reduce((a, b) => a + b, 0) / actuals.length || 0;

    forecast = actuals.map(() => avg);
  }

  renderExpenseChart(labels, actuals, forecast);
}

/* ===============================
   RENDER CHART
================================ */
function renderExpenseChart(labels, actuals, forecast) {
  const ctx = document.getElementById("expenseTrend").getContext("2d");

  if (expenseChart) expenseChart.destroy();

  expenseChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Actual Spend",
          data: actuals,
          borderColor: "#5B6EFF",
          backgroundColor: "rgba(91,110,255,0.15)",
          tension: 0.45,
          fill: true,
          pointRadius: 4
        },
        forecast.length
          ? {
              label: "Forecast",
              data: forecast,
              borderColor: "#999",
              borderDash: [6, 6],
              tension: 0.45,
              pointRadius: 0
            }
          : null
      ].filter(Boolean)
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false }
      },
      scales: {
        x: {
          grid: { display: false }
        },
        y: {
          grid: { display: false },
          ticks: {
            callback: v => "‚Çπ" + v.toLocaleString()
          }
        }
      }
    }
  });
}
</script>

  <!-- ===============================
     EXPENSE CATEGORIES
================================ -->
<section class="card">
  <h3 class="section-title">Expense Categories</h3>

  <div class="category-layout">
    <canvas id="categoryDonut"></canvas>

    <div id="categoryList" class="category-list"></div>
  </div>
</section>

<style>
.category-layout {
  display: grid;
  grid-template-columns: 220px 1fr;
  gap: 20px;
  align-items: center;
}

@media (max-width: 768px) {
  .category-layout {
    grid-template-columns: 1fr;
  }
}

.category-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.category-row {
  display: flex;
  justify-content: space-between;
  padding: 10px 14px;
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.04);
  font-size: 14px;
}

.category-row.over {
  border-left: 4px solid var(--accent-red);
}

.category-row.ok {
  border-left: 4px solid var(--accent-green);
}

.category-name {
  font-weight: 500;
}

.category-amt {
  font-weight: 600;
}
</style>

<script>
let categoryChart;

/* ===============================
   LOAD CATEGORY INSIGHTS
================================ */
async function loadCategories() {
  const rows = await fetchSheet("Budget_vs_Actual");

  const currentMonth = formatMonthYYYYMM(CURRENT_MONTH);

  const map = {};

  rows.forEach(r => {
    const monthMatch =
      VIEW_MODE === "MONTH"
        ? r.Month === currentMonth
        : r.Month.startsWith(CURRENT_MONTH.getFullYear());

    if (!monthMatch) return;

    if (!map[r.Category]) {
      map[r.Category] = { actual: 0, budget: 0 };
    }

    map[r.Category].actual += Number(r.Actual_Amount || 0);
    map[r.Category].budget += Number(r.Budget_Amount || 0);
  });

  const labels = [];
  const values = [];
  const list = [];

  Object.entries(map).forEach(([cat, v]) => {
    if (v.actual <= 0) return;

    labels.push(cat);
    values.push(v.actual);

    list.push({
      cat,
      actual: v.actual,
      budget: v.budget,
      over: v.actual > v.budget
    });
  });

  renderCategoryDonut(labels, values);
  renderCategoryList(list);
}

/* ===============================
   DONUT
================================ */
function renderCategoryDonut(labels, values) {
  const ctx = document.getElementById("categoryDonut");

  if (categoryChart) categoryChart.destroy();

  categoryChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: [
          "#5B6EFF",
          "#34C759",
          "#FF9F0A",
          "#FF453A",
          "#8E8E93",
          "#64D2FF"
        ]
      }]
    },
    options: {
      plugins: {
        legend: { display: false }
      },
      cutout: "70%"
    }
  });
}

/* ===============================
   LIST
================================ */
function renderCategoryList(items) {
  const box = document.getElementById("categoryList");
  box.innerHTML = "";

  items
    .sort((a,b) => b.actual - a.actual)
    .forEach(i => {
      const row = document.createElement("div");
      row.className = "category-row " + (i.over ? "over" : "ok");

      row.innerHTML = `
        <span class="category-name">${i.cat}</span>
        <span class="category-amt">${money(i.actual)}</span>
      `;

      box.appendChild(row);
    });
}
</script>

  <!-- ===============================
     EMI DETAILS
================================ -->
<section class="card">
  <h3 class="section-title">EMI Commitments</h3>

  <div id="emiSummary" class="emi-summary"></div>

  <div id="emiList" class="emi-list"></div>
</section>

<style>
.emi-summary {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
  gap: 14px;
  margin-bottom: 20px;
}

.emi-box {
  padding: 14px;
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.06);
}

.emi-box span {
  display: block;
  font-size: 12px;
  color: var(--text-muted);
}

.emi-box strong {
  font-size: 18px;
  margin-top: 4px;
  display: block;
}

.emi-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.emi-row {
  display: grid;
  grid-template-columns: 1.6fr 1fr 1fr 1fr;
  gap: 10px;
  padding: 12px;
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.04);
  font-size: 14px;
}

@media(max-width:768px){
  .emi-row {
    grid-template-columns: 1fr;
    gap: 6px;
  }
}

.emi-name {
  font-weight: 500;
}

.emi-danger {
  color: var(--accent-red);
}

.emi-ok {
  color: var(--accent-green);
}
</style>

<script>
/* ===============================
   EMI LOADER
================================ */
async function loadEMIs() {
  const rows = await fetchSheet("EMI_Master");

  let totalMonthly = 0;
  let remainingTotal = 0;
  let nextEmi = null;

  const today = new Date();

  const listBox = document.getElementById("emiList");
  listBox.innerHTML = "";

  rows.forEach(r => {
    if (Number(r.Months_Remaining) <= 0) return;

    totalMonthly += Number(r.Monthly_Amount || 0);
    remainingTotal += Number(r.Remaining_Liability || 0);

    // Calculate next due date
    const dueDay = Number(r.Due_Day || 1);
    let dueDate = new Date(today.getFullYear(), today.getMonth(), dueDay);
    if (dueDate < today) {
      dueDate = new Date(today.getFullYear(), today.getMonth() + 1, dueDay);
    }

    const daysLeft = Math.ceil(
      (dueDate - today) / (1000 * 60 * 60 * 24)
    );

    if (!nextEmi || daysLeft < nextEmi.daysLeft) {
      nextEmi = {
        name: r.EMI_Name,
        daysLeft,
        amount: r.Monthly_Amount
      };
    }

    const row = document.createElement("div");
    row.className = "emi-row";

    row.innerHTML = `
      <div class="emi-name">${r.EMI_Name}</div>
      <div>${money(r.Monthly_Amount)} / month</div>
      <div>${r.Months_Remaining} months left</div>
      <div class="${daysLeft <= 7 ? 'emi-danger' : 'emi-ok'}">
        Due in ${daysLeft} days
      </div>
    `;

    listBox.appendChild(row);
  });

  /* Summary */
  const summary = document.getElementById("emiSummary");
  summary.innerHTML = `
    <div class="emi-box">
      <span>Monthly EMI Load</span>
      <strong>${money(totalMonthly)}</strong>
    </div>

    <div class="emi-box">
      <span>Remaining EMI Liability</span>
      <strong>${money(remainingTotal)}</strong>
    </div>

    <div class="emi-box">
      <span>Next EMI</span>
      <strong>
        ${nextEmi ? nextEmi.name : "‚Äî"}
      </strong>
      <span>
        ${nextEmi ? `${nextEmi.daysLeft} days ¬∑ ${money(nextEmi.amount)}` : ""}
      </span>
    </div>
  `;
}
</script>

  <!-- ===============================
     ACCOUNT BALANCES
================================ -->
<section class="card">
  <h3 class="section-title">Account Balances</h3>

  <div id="accountList" class="account-list"></div>
</section>

<style>
.account-list {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.account-row {
  display: grid;
  grid-template-columns: 1.4fr 1fr 1fr;
  gap: 10px;
  padding: 14px;
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.05);
  align-items: center;
}

@media(max-width:768px){
  .account-row {
    grid-template-columns: 1fr;
    gap: 6px;
  }
}

.account-name {
  font-weight: 500;
}

.account-balance {
  font-weight: 600;
}

.account-ok {
  color: var(--accent-green);
}

.account-low {
  color: var(--accent-orange);
}

.account-critical {
  color: var(--accent-red);
}

.account-hint {
  font-size: 12px;
  color: var(--text-muted);
}
</style>

<script>
/* ===============================
   ACCOUNT BALANCE LOADER
================================ */
async function loadAccounts() {
  const rows = await fetchSheet("Account_Balances_Live");
  const box = document.getElementById("accountList");
  box.innerHTML = "";

  rows.forEach(r => {
    const bal = Number(r.Live_Balance || 0);
    const safe = Number(r.Safe_Limit || 1500);

    let statusClass = "account-ok";
    let hint = "Balance healthy";

    if (bal <= 0) {
      statusClass = "account-critical";
      hint = "Critical balance ‚Äì action required";
    } else if (bal < safe) {
      statusClass = "account-low";
      hint = `Below safe limit ‚Çπ${safe.toLocaleString("en-IN")}`;
    }

    const row = document.createElement("div");
    row.className = "account-row";

    row.innerHTML = `
      <div class="account-name">${r.Account}</div>
      <div class="account-balance ${statusClass}">
        ${money(bal)}
      </div>
      <div class="account-hint">${hint}</div>
    `;

    box.appendChild(row);
  });
}
</script>

  <!-- ===============================
     AI INSIGHTS
================================ -->
<section class="card">
  <h3 class="section-title">AI Insights</h3>

  <div id="aiInsights" class="ai-list"></div>
</section>

<style>
.ai-list {
  display: flex;
  flex-direction: column;
  gap: 14px;
}

.ai-item {
  padding: 14px;
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.05);
  border-left: 5px solid transparent;
}

.ai-item.high {
  border-color: var(--accent-red);
}

.ai-item.medium {
  border-color: var(--accent-orange);
}

.ai-item.low {
  border-color: var(--accent-green);
}

.ai-title {
  font-weight: 600;
  margin-bottom: 4px;
}

.ai-text {
  font-size: 14px;
  color: var(--text-muted);
}

.ai-action {
  margin-top: 6px;
  font-size: 13px;
  color: var(--accent-blue);
}
</style>

<script>
/* ===============================
   AI INSIGHT ENGINE
================================ */
async function loadAIInsights() {
  const insights = [];
  const today = new Date();

  /* ---------- BALANCE RISK ---------- */
  const accounts = await fetchSheet("Account_Balances_Live");

  accounts.forEach(a => {
    const bal = Number(a.Live_Balance || 0);
    const safe = Number(a.Safe_Limit || 1500);

    if (bal < safe) {
      insights.push({
        level: bal <= 0 ? "high" : "medium",
        title: `Low Balance ‚Äì ${a.Account}`,
        text:
          `Current balance ${money(bal)} is below the safe limit ${money(safe)}.`,
        action:
          "Consider transferring funds from another account."
      });
    }
  });

  /* ---------- BUDGET OVERRUN ---------- */
  const budgets = await fetchSheet("Budget_vs_Actual");
  const month = formatMonthYYYYMM(CURRENT_MONTH);

  budgets.forEach(b => {
    if (VIEW_MODE === "MONTH" && b.Month !== month) return;

    if (Number(b.Actual_Amount) > Number(b.Budget_Amount)) {
      insights.push({
        level: "medium",
        title: `Overspent ‚Äì ${b.Category}`,
        text:
          `Spent ${money(b.Actual_Amount)} against budget ${money(b.Budget_Amount)}.`,
        action:
          "Reduce discretionary spend in this category."
      });
    }
  });

  /* ---------- EMI STRESS ---------- */
  const emis = await fetchSheet("EMI_Master");

  emis.forEach(e => {
    if (Number(e.Months_Remaining) <= 0) return;

    const dueDay = Number(e.Due_Day || 1);
    let due = new Date(today.getFullYear(), today.getMonth(), dueDay);
    if (due < today) {
      due = new Date(today.getFullYear(), today.getMonth() + 1, dueDay);
    }

    const daysLeft = Math.ceil(
      (due - today) / (1000 * 60 * 60 * 24)
    );

    if (daysLeft <= 7) {
      insights.push({
        level: "high",
        title: `Upcoming EMI ‚Äì ${e.EMI_Name}`,
        text:
          `EMI of ${money(e.Monthly_Amount)} is due in ${daysLeft} days.`,
        action:
          "Ensure sufficient balance before due date."
      });
    }
  });

  renderAIInsights(insights.slice(0, 4));
}

/* ===============================
   RENDER INSIGHTS
================================ */
function renderAIInsights(items) {
  const box = document.getElementById("aiInsights");
  box.innerHTML = "";

  if (items.length === 0) {
    box.innerHTML = `
      <div class="ai-item low">
        <div class="ai-title">All Clear üëç</div>
        <div class="ai-text">
          No financial risks detected at the moment.
        </div>
      </div>
    `;
    return;
  }

  items.forEach(i => {
    const div = document.createElement("div");
    div.className = `ai-item ${i.level}`;

    div.innerHTML = `
      <div class="ai-title">${i.title}</div>
      <div class="ai-text">${i.text}</div>
      <div class="ai-action">${i.action}</div>
    `;

    box.appendChild(div);
  });
}
</script>

  <!-- ===============================
     SPENDING BEHAVIOUR
================================ -->
<section class="card">
  <h3 class="section-title">Spending Behaviour</h3>

  <div class="spend-toggle">
    <button onclick="setSpendDays(7)">Last 7 Days</button>
    <button onclick="setSpendDays(15)">Last 15 Days</button>
  </div>

  <div id="spendingList" class="spending-list"></div>
</section>

<style>
.spend-toggle {
  display: flex;
  gap: 10px;
  margin-bottom: 12px;
}

.spend-toggle button {
  padding: 6px 12px;
  border-radius: 999px;
  border: 1px solid var(--border-soft);
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 13px;
}

.spend-toggle button:hover {
  color: var(--text-main);
  border-color: var(--accent-blue);
}

.spending-list {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.spend-row {
  display: grid;
  grid-template-columns: 80px 1fr auto;
  gap: 12px;
  padding: 12px;
  border-radius: var(--radius-md);
  background: rgba(255,255,255,0.04);
  font-size: 14px;
}

@media(max-width:768px){
  .spend-row {
    grid-template-columns: 70px 1fr auto;
  }
}

.spend-date {
  font-weight: 500;
  color: var(--accent-blue);
}

.spend-cat {
  font-size: 14px;
}

.spend-amt {
  font-weight: 600;
  color: var(--accent-red);
}
</style>

<script>
let SPEND_DAYS = 7;

/* ===============================
   SET DAYS
================================ */
function setSpendDays(days) {
  SPEND_DAYS = days;
  loadSpendingBehaviour();
}

/* ===============================
   LOAD SPENDING
================================ */
async function loadSpendingBehaviour() {
  const rows = await fetchSheet("Txn_Clean");
  const today = new Date();

  let startDate;

  if (VIEW_MODE === "MONTH") {
    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
  } else {
    startDate = new Date(today.getFullYear(), 0, 1);
  }

  const cutoff = new Date(today);
  cutoff.setDate(today.getDate() - SPEND_DAYS);

  const list = document.getElementById("spendingList");
  list.innerHTML = "";

  const filtered = rows
    .filter(r => {
      if (!r.Txn_Date) return false;

      const d = new Date(r.Txn_Date);
      if (d < startDate || d > today) return false;
      if (d < cutoff) return false;
      if (Number(r.Signed_Amount) >= 0) return false;

      return true;
    })
    .sort((a,b) => new Date(b.Txn_Date) - new Date(a.Txn_Date));

  if (filtered.length === 0) {
    list.innerHTML = `
      <div class="spend-row">
        <div class="spend-cat">No expenses recorded</div>
      </div>
    `;
    return;
  }

  filtered.forEach(t => {
    const d = new Date(t.Txn_Date);

    const row = document.createElement("div");
    row.className = "spend-row";

    row.innerHTML = `
      <div class="spend-date">
        ${d.toLocaleDateString("en-IN",{day:"2-digit",month:"short"})}
      </div>
      <div class="spend-cat">
        ${t.Category}
      </div>
      <div class="spend-amt">
        ${money(Math.abs(t.Signed_Amount))}
      </div>
    `;

    list.appendChild(row);
  });
}
</script>
<!-- ===============================
     FOOTER
================================ -->
<footer class="app-footer">
  <div class="footer-left">
    <strong>Kaiwalya‚Äôs Finance Dashboard</strong>
    <div class="footer-sub">
      Built for clarity ¬∑ Updated live from Google Sheets
    </div>
  </div>

  <div class="footer-right">
    <button onclick="refreshDashboard()" class="refresh-btn">
      ‚Üª Refresh
    </button>
  </div>
</footer>

<style>
/* ===============================
   FOOTER
================================ */
.app-footer {
  margin-top: 40px;
  padding: 20px 10px 30px;
  border-top: 1px solid var(--border-soft);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: 13px;
  color: var(--text-muted);
}

.footer-sub {
  margin-top: 4px;
  font-size: 12px;
}

.refresh-btn {
  padding: 6px 14px;
  border-radius: 999px;
  border: 1px solid var(--border-soft);
  background: transparent;
  color: var(--text-main);
  cursor: pointer;
}

.refresh-btn:hover {
  border-color: var(--accent-blue);
  color: var(--accent-blue);
}

/* ===============================
   PWA INSTALL PROMPT
================================ */
#pwaPrompt {
  position: fixed;
  bottom: 18px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(20,22,30,0.95);
  border: 1px solid var(--border-soft);
  border-radius: var(--radius-lg);
  padding: 14px 18px;
  display: none;
  align-items: center;
  gap: 14px;
  z-index: 999;
}

#pwaPrompt button {
  background: var(--accent-blue);
  border: none;
  color: #fff;
  border-radius: 999px;
  padding: 6px 14px;
  cursor: pointer;
}
</style>

<div id="pwaPrompt">
  <div>
    <strong>Install Dashboard</strong>
    <div class="footer-sub">Use it like a real app</div>
  </div>
  <button id="installBtn">Install</button>
</div>

<script>
/* ===============================
   FINAL WIRING
================================ */

/* Re-run everything cleanly */
async function refreshDashboard() {
  console.log("Refreshing dashboard‚Ä¶");

  await loadKPIs();
  await loadBudgetBar();
  await loadExpenseTrend();
  await loadCategories();
  await loadEMIs();
  await loadAccounts();
  await loadAIInsights();
  await loadSpendingBehaviour();
}

/* ===============================
   PWA INSTALL SUPPORT
================================ */
let deferredPrompt;

window.addEventListener("beforeinstallprompt", e => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById("pwaPrompt").style.display = "flex";
});

document.getElementById("installBtn").onclick = async () => {
  if (!deferredPrompt) return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt = null;
  document.getElementById("pwaPrompt").style.display = "none";
};

/* ===============================
   AUTO REFRESH (OPTIONAL)
================================ */
// Refresh every 10 minutes
setInterval(refreshDashboard, 10 * 60 * 1000);
</script>

</div> <!-- END app-container -->
</body>
</html>
  
