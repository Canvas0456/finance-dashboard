<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personal Dashboard</title>

<style>
:root {
  --bg: #f7f8fa;
  --card: #ffffff;
  --text: #1c1c1e;
  --muted: #6e6e73;
  --good: #34c759;
  --warn: #ff9f0a;
  --alert: #ff453a;
  --radius: 14px;
  --shadow: 0 6px 20px rgba(0,0,0,0.06);
}

* {
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
}

body {
  margin: 0;
  background: var(--bg);
  color: var(--text);
}

.app {
  max-width: 1100px;
  margin: auto;
  padding: 20px;
}

/* HEADER */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}

.date {
  font-size: 14px;
  color: var(--muted);
}

.streak {
  font-size: 14px;
  background: var(--card);
  padding: 8px 14px;
  border-radius: 999px;
  box-shadow: var(--shadow);
}

/* KPI GRID */
.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 16px;
}

.kpi {
  background: var(--card);
  border-radius: var(--radius);
  padding: 16px;
  box-shadow: var(--shadow);
}

.kpi-title {
  font-size: 13px;
  color: var(--muted);
}

.kpi-value {
  font-size: 26px;
  font-weight: 600;
}

.kpi-status {
  font-size: 12px;
  margin-top: 4px;
}

.good { color: var(--good); }
.warn { color: var(--warn); }
.alert { color: var(--alert); }

/* FORMS */
.form-card {
  background: var(--card);
  padding: 16px;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  margin-top: 24px;
}

input, select, button {
  width: 100%;
  padding: 10px;
  margin-top: 10px;
  border-radius: 10px;
  border: 1px solid #ddd;
}

button {
  background: #000;
  color: #fff;
  border: none;
  cursor: pointer;
}
</style>
</head>

  <body>
<div class="app">

  <div class="header">
    <div class="date" id="todayDate">â€”</div>
    <div class="streak">ðŸ”¥ <span id="streakCount">1</span>-day streak</div>
  </div>

  <!-- KPI GRID -->
  <div class="kpi-grid" id="kpiGrid"></div>

  <!-- TRANSACTION FORM -->
  <div class="form-card">
    <h3>Add Transaction</h3>
    <input type="date" id="txnDate">
    <input type="text" id="txnAccount" placeholder="Account">
    <select id="txnType">
      <option>Income</option>
      <option>Expense</option>
      <option>Investment</option>
      <option>EMI</option>
    </select>
    <input type="text" id="txnCategory" placeholder="Category">
    <input type="number" id="txnAmount" placeholder="Amount">
    <button onclick="submitTransaction()">Save Transaction</button>
  </div>

  <!-- HEALTH FORM -->
  <div class="form-card">
    <h3>Daily Health Entry</h3>
    <input type="date" id="healthDate">
    <input type="number" id="healthSteps" placeholder="Steps">
    <input type="number" id="healthSleep" placeholder="Sleep Hours">
    <input type="text" id="healthWorkout" placeholder="Workout Type">
    <input type="number" min="1" max="10" id="healthStress" placeholder="Stress (1-10)">
    <button onclick="submitHealth()">Save Health Entry</button>
  </div>

  <!-- DEBUG PANEL -->
  <div class="form-card" style="font-size:13px;color:#666;">
    <b>Last Action:</b> <span id="lastAction">None</span><br>
    <b>Last Commit Attempt:</b> <span id="lastCommit">Never</span>
  </div>

  <script>
const API_BASE =
"https://script.google.com/macros/s/AKfycbw8xsP1TRYdTP7FkASoX_O4n25rt8vhaO-DhU-6GgiktTCSVzZWtkEFjrVWIjpPVuoh/exec";

/* DATE */
todayDate.innerText =
  new Date().toLocaleDateString("en-IN",{day:"numeric",month:"short",year:"numeric"});

/* KPI FETCH */
fetch(API_BASE + "?sheet=KPI_Cards")
.then(r=>r.json())
.then(d=>{
  kpiGrid.innerHTML="";
  d.rows.forEach(r=>{
    let val=r.Value;
    if(r.Unit==="INR") val="â‚¹"+Math.round(val);
    if(r.Unit==="%") val=Math.round(val*100)+"%";
    kpiGrid.innerHTML+=`
      <div class="kpi">
        <div class="kpi-title">${r.Metric.replaceAll("_"," ")}</div>
        <div class="kpi-value">${val}</div>
        <div class="kpi-status ${r.Status.toLowerCase()}">${r.Status}</div>
      </div>`;
  });
});

/* DEBUG */
function updateCommitLog(msg){
  lastAction.innerText=msg;
  lastCommit.innerText=new Date().toLocaleString();
}

/* TRANSACTION */
function submitTransaction(){
  updateCommitLog("Transaction button clicked");
  const payload={
    sheet:"TXN_Raw",
    values:[
      txnDate.value,
      txnAccount.value,
      txnType.value,
      txnCategory.value,
      "",
      Number(txnAmount.value),
      ""
    ]
  };

  fetch(API_BASE,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  })
  .then(r=>r.text())
  .then(t=>updateCommitLog("Response: "+t))
  .catch(e=>updateCommitLog("ERROR: "+e));
}

/* HEALTH */
function submitHealth(){
  updateCommitLog("Health button clicked");
  const payload={
    sheet:"Health_Raw",
    values:[
      healthDate.value,
      Number(healthSteps.value),
      "",
      healthWorkout.value,
      "",
      Number(healthSleep.value),
      "",
      Number(healthStress.value)
    ]
  };

  fetch(API_BASE,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  })
  .then(r=>r.text())
  .then(t=>updateCommitLog("Response: "+t))
  .catch(e=>updateCommitLog("ERROR: "+e));

  /* STREAK */
const STREAK_KEY="dashboard_streak";
const LAST_KEY="dashboard_last";

function dstr(d=new Date()){return d.toISOString().split("T")[0];}

function updateStreak(){
  const today=dstr(),yesterday=dstr(new Date(Date.now()-86400000));
  let s=Number(localStorage.getItem(STREAK_KEY))||0;
  const last=localStorage.getItem(LAST_KEY);

  if(last===yesterday) s++;
  else if(last!==today) s=1;

  localStorage.setItem(STREAK_KEY,s);
  localStorage.setItem(LAST_KEY,today);
  streakCount.innerText=s;
}

updateStreak();
</script>

</div>
</body>
</html>
