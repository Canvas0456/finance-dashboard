<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kaiwalya’s Finance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#faf8f2;
  --card:#ffffff;
  --text:#2e2e2e;
  --muted:#7a7a7a;
  --accent:#9c8b6a;
}

body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:var(--bg);
  color:var(--text);
}

header{
  position:sticky;
  top:0;
  background:var(--bg);
  padding:16px 20px;
  border-bottom:1px solid #e6e2d8;
  z-index:10;
}

.header-row{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
}

h1{
  margin:0;
  font-size:22px;
}

.subtitle{
  font-size:13px;
  color:var(--muted);
  margin-top:4px;
}

.date{
  font-size:14px;
  color:var(--muted);
}

.container{
  padding:20px;
  max-width:1100px;
  margin:auto;
}

.thought{
  border:1px dashed #ddd6c9;
  padding:12px;
  border-radius:12px;
  color:var(--muted);
  margin-bottom:20px;
  font-size:14px;
}

.toggle{
  display:flex;
  gap:8px;
  margin-bottom:20px;
}

.toggle button{
  border:1px solid #d6cfbf;
  background:white;
  padding:8px 14px;
  border-radius:20px;
  cursor:pointer;
}

.toggle button.active{
  background:var(--accent);
  color:white;
}

.kpis{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:16px;
}

.card{
  background:var(--card);
  border-radius:18px;
  padding:16px;
  box-shadow:0 4px 14px rgba(0,0,0,0.04);
}

.card h3{
  margin:0;
  font-size:14px;
  color:var(--muted);
}

.card .value{
  font-size:26px;
  font-weight:600;
  margin-top:6px;
}

.bar-wrap{
  margin-top:20px;
}

.bar{
  height:10px;
  background:#e8e3d8;
  border-radius:6px;
  overflow:hidden;
}

.bar span{
  display:block;
  height:100%;
  background:var(--accent);
}

.bar-label{
  display:flex;
  justify-content:space-between;
  font-size:13px;
  margin-top:6px;
  color:var(--muted);
}

.section{
  margin-top:32px;
}

.section h2{
  font-size:18px;
  margin-bottom:12px;
}

.accounts{
  background:white;
  border-radius:16px;
  overflow:hidden;
}

.accounts div{
  display:flex;
  justify-content:space-between;
  padding:12px 16px;
  border-bottom:1px solid #f0ede5;
}

.accounts div:last-child{border-bottom:none;}

canvas{
  background:white;
  border-radius:16px;
  padding:12px;
}
</style>
</head>

<body>

<header>
  <div class="header-row">
    <div>
      <h1>Kaiwalya’s Finance Dashboard</h1>
      <div class="subtitle">“Calm tracking leads to better decisions.”</div>
    </div>
    <div class="date" id="todayDate"></div>
  </div>
</header>

<div class="container">

<div class="thought" id="thoughtBox">Loading today’s thought…</div>

<div class="toggle">
  <button id="monthBtn" class="active">Month</button>
  <button id="ytdBtn">YTD</button>
</div>

<div class="kpis">
  <div class="card"><h3>Total Balance</h3><div class="value" id="bal">—</div></div>
  <div class="card"><h3>Total Expenses</h3><div class="value" id="exp">—</div></div>
  <div class="card"><h3>Budget Remaining</h3><div class="value" id="remain">—</div></div>
  <div class="card"><h3>Budget Burn %</h3><div class="value" id="burn">—</div></div>
</div>

<div class="bar-wrap">
  <div class="bar"><span id="burnBar"></span></div>
  <div class="bar-label">
    <span id="usedLbl">Used: 0%</span>
    <span id="remLbl">Remaining: 100%</span>
  </div>
</div>

<div class="section">
  <h2>Account Balances</h2>
  <div class="accounts" id="accounts"></div>
</div>

<div class="section">
  <h2>Expense Trend</h2>
  <canvas id="trendChart" height="120"></canvas>
  <div class="subtitle" id="chartCaption"></div>
</div>

</div>

<script>
const SHEET_ID = "1ApiV5dmKYycVw2IEnVKkNHY2ssLcOZZ1v1slU57UqM0";

const today = new Date();
document.getElementById("todayDate").innerText =
  today.toLocaleDateString("en-GB",{day:"2-digit",month:"short",year:"numeric"});

fetch("https://api.quotable.io/random")
.then(r=>r.json())
.then(d=>document.getElementById("thoughtBox").innerText=d.content)
.catch(()=>document.getElementById("thoughtBox").innerText="Stay consistent. Money follows clarity.");

function fetchSheet(sheet){
  return fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${sheet}`)
    .then(r=>r.text())
    .then(t=>JSON.parse(t.substr(47).slice(0,-2)));
}

/* KPIs */
fetchSheet("Dashboard_KPIs").then(d=>{
  const rows=d.table.rows;
  const val=k=>rows.find(r=>r.c[0]?.v===k)?.c[1]?.v||0;
  document.getElementById("bal").innerText="₹"+val("Total Balance (All Accounts)").toLocaleString();
  document.getElementById("exp").innerText="₹"+val("Current Month Expenses").toLocaleString();
  const remain = val("Total Balance (All Accounts)") - val("Current Month Expenses");
  document.getElementById("remain").innerText="₹"+remain.toLocaleString();
  const burn=Math.round(val("Budget Used %")*100);
  document.getElementById("burn").innerText=burn+"%";
  document.getElementById("burnBar").style.width=burn+"%";
  document.getElementById("usedLbl").innerText="Used: "+burn+"%";
  document.getElementById("remLbl").innerText="Remaining: "+(100-burn)+"%";
});

/* Accounts */
fetchSheet("Account_Balances_Live").then(d=>{
  const wrap=document.getElementById("accounts");
  d.table.rows.forEach(r=>{
    wrap.innerHTML+=`<div><span>${r.c[0].v}</span><strong>₹${r.c[4].v.toLocaleString()}</strong></div>`;
  });
});

/* Trend */
let rows=[];
const ctx=document.getElementById("trendChart").getContext("2d");
const chart=new Chart(ctx,{
  type:"line",
  data:{labels:[],datasets:[{data:[],borderColor:"#9c8b6a",tension:.4,fill:false}]},
  options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{grid:{display:false}}}}
});

fetchSheet("Txn_Clean").then(d=>{
  rows=d.table.rows;
  showMonth();
});

function showMonth(){
  const weeks=[0,0,0,0,0];
  const month=today.toISOString().slice(0,7);
  const todaySerial=Math.floor(today/86400000)+25569;

  rows.forEach(r=>{
    if(!r.c[11]?.v) return;
    if(r.c[3].v!==month) return;
    if(r.c[1].v>todaySerial) return;
    const day=new Date((r.c[1].v-25569)*86400000).getDate();
    weeks[Math.min(4,Math.floor((day-1)/7))]+=Math.abs(r.c[4].v);
  });

  chart.data.labels=["W1","W2","W3","W4","W5"];
  chart.data.datasets[0].data=weeks;
  chart.update();
  chartCaption.innerText="Weekly expenses — current month";
}

function showYTD(){
  const months=Array(12).fill(0);
  const yearStart=Math.floor(new Date(today.getFullYear(),0,1)/86400000)+25569;
  const todaySerial=Math.floor(today/86400000)+25569;

  rows.forEach(r=>{
    if(!r.c[11]?.v) return;
    if(r.c[1].v<yearStart||r.c[1].v>todaySerial) return;
    const m=new Date((r.c[1].v-25569)*86400000).getMonth();
    months[m]+=Math.abs(r.c[4].v);
  });

  const m=today.getMonth();
  chart.data.labels=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].slice(0,m+1);
  chart.data.datasets[0].data=months.slice(0,m+1);
  chart.update();
  chartCaption.innerText="Monthly expenses — YTD till today";
}

monthBtn.onclick=()=>{monthBtn.classList.add("active");ytdBtn.classList.remove("active");showMonth();}
ytdBtn.onclick=()=>{ytdBtn.classList.add("active");monthBtn.classList.remove("active");showYTD();}
</script>

</body>
</html>
