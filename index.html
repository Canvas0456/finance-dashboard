<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kaiwalya’s Finance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f8f5f0;
  --card:#fffdf9;
  --border:#e7e2d9;
  --text:#2f2f2f;
  --muted:#7a746b;
  --accent:#8b7d6b;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  font-family:system-ui,-apple-system;
  color:var(--text);
}

/* HEADER */
.header{
  position:fixed;
  top:0; left:0; right:0;
  background:var(--card);
  border-bottom:1px solid var(--border);
  padding:12px 16px;
  z-index:1000;
}
.header-top{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.title{font-size:17px;font-weight:600}
.date{font-size:13px;color:var(--muted)}
.subtitle{font-size:12px;color:var(--muted);margin-top:4px}

/* CONTENT */
.container{padding:110px 14px 30px}

/* THOUGHT */
.thought{
  background:var(--card);
  border:1px dashed var(--border);
  border-radius:12px;
  padding:12px;
  font-size:13px;
  color:var(--muted);
  margin-bottom:16px;
}

/* TOGGLES */
.toggle{
  display:flex;
  gap:8px;
  margin-bottom:16px;
}
.toggle button{
  flex:1;
  padding:8px;
  border-radius:10px;
  border:1px solid var(--border);
  background:var(--card);
  font-size:13px;
  cursor:pointer;
}
.toggle button.active{
  background:#efe9e1;
  border-color:var(--accent);
}

/* KPI */
.kpi-grid{
  display:grid;
  grid-template-columns:repeat(2,1fr);
  gap:12px;
}
.kpi{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
}
.kpi h3{
  margin:0;
  font-size:12px;
  color:var(--muted);
}
.kpi p{
  margin-top:6px;
  font-size:20px;
  font-weight:600;
}

/* BUDGET BAR */
.budget{margin-top:16px}
.budget-labels{
  display:flex;
  justify-content:space-between;
  font-size:12px;
  color:var(--muted);
  margin-bottom:6px;
}
.bar-bg{
  height:10px;
  background:#e7e2d9;
  border-radius:999px;
  overflow:hidden;
}
.bar-used{
  height:100%;
  background:var(--accent);
  width:0%;
}

/* ACCOUNTS */
.section-title{
  margin-top:22px;
  margin-bottom:8px;
  font-size:14px;
  font-weight:600;
}
.account-list{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  overflow:hidden;
}
.account-row{
  display:flex;
  justify-content:space-between;
  padding:12px 14px;
  border-bottom:1px solid var(--border);
  font-size:14px;
}
.account-row:last-child{border-bottom:none}
.account-name{color:var(--muted)}
.account-amt{font-weight:600}

/* CHART */
.chart-card{
  margin-top:22px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:14px;
  padding:14px;
}
.chart-caption{
  font-size:11px;
  color:var(--muted);
  margin-top:6px;
}
</style>
</head>

<body>

<div class="header">
  <div class="header-top">
    <div class="title">Kaiwalya’s Finance Dashboard</div>
    <div class="date" id="todayDate"></div>
  </div>
  <div class="subtitle">“Calm tracking leads to better decisions.”</div>
</div>

<div class="container">

  <div class="thought" id="thought">Loading today’s thought…</div>

  <div class="toggle">
    <button id="btnMonth" class="active">Month</button>
    <button id="btnYTD">YTD</button>
  </div>

  <div class="kpi-grid">
    <div class="kpi"><h3>Total Balance</h3><p id="kBalance">–</p></div>
    <div class="kpi"><h3>Total Expenses</h3><p id="kExpense">–</p></div>
    <div class="kpi"><h3>Budget Remaining</h3><p id="kRemain">–</p></div>
    <div class="kpi"><h3>Budget Burn %</h3><p id="kBurn">–%</p></div>
  </div>

  <div class="budget">
    <div class="budget-labels">
      <span id="usedLabel">Used: –%</span>
      <span id="remainLabel">Remaining: –%</span>
    </div>
    <div class="bar-bg"><div class="bar-used" id="budgetBar"></div></div>
  </div>

  <div class="section-title">Account Balances</div>
  <div class="account-list" id="accounts"></div>

  <div class="chart-card">
    <canvas id="trendChart" height="140"></canvas>
    <div class="chart-caption" id="chartCaption"></div>
  </div>

</div>

<script>
const SHEET_ID="1ApiV5dmKYycVw2IEnVKkNHY2ssLcOZZ1v1slU57UqM0";
todayDate.innerText=new Date().toLocaleDateString("en-IN",{day:"2-digit",month:"short",year:"numeric"});

/* Thought */
fetch("https://api.allorigins.win/raw?url=https://zenquotes.io/api/today")
.then(r=>r.json())
.then(d=>thought.innerText=d[0].q)
.catch(()=>thought.innerText="Consistency is more powerful than intensity.");

/* Fetch helper */
function fetchSheet(sheet){
  return fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${sheet}`)
    .then(r=>r.text())
    .then(t=>JSON.parse(t.substring(47).slice(0,-2)));
}

/* KPIs */
fetchSheet("Dashboard_KPIs").then(d=>{
  let bal=0, exp=0, burn=0;
  d.table.rows.forEach(r=>{
    const k=r.c[0]?.v, v=r.c[1]?.v;
    if(k==="Total Balance (All Accounts)") bal=v;
    if(k==="Current Month Expenses") exp=v;
    if(k==="Budget Used %") burn=v;
  });
  const used=Math.round(burn*100), rem=100-used;
  kBalance.innerText="₹"+bal.toLocaleString("en-IN");
  kExpense.innerText="₹"+exp.toLocaleString("en-IN");
  kBurn.innerText=used+"%";
  kRemain.innerText="₹"+(bal-exp).toLocaleString("en-IN");
  budgetBar.style.width=used+"%";
  usedLabel.innerText="Used: "+used+"%";
  remainLabel.innerText="Remaining: "+rem+"%";
});

/* Accounts */
fetchSheet("Account_Balances_Live").then(d=>{
  d.table.rows.forEach(r=>{
    if(!r.c[0]?.v) return;
    accounts.innerHTML+=`
      <div class="account-row">
        <div class="account-name">${r.c[0].v}</div>
        <div class="account-amt">₹${r.c[4].v.toLocaleString("en-IN")}</div>
      </div>`;
  });
});

/* Trend Chart */
const ctx=document.getElementById("trendChart");
let chart=new Chart(ctx,{
  type:"line",
  data:{labels:[],datasets:[{data:[],borderColor:"#8b7d6b",tension:.4,pointRadius:4}]},
  options:{plugins:{legend:{display:false}},scales:{x:{grid:{display:false}},y:{grid:{display:false}}}}
});

/* REAL DATA FROM Txn_Clean */
fetchSheet("Txn_Clean").then(d=>{
  const rows=d.table.rows;
  const currentMonth=new Date().toISOString().slice(0,7);

  function showMonth(){
    const weeks=[0,0,0,0,0];
    rows.forEach(r=>{
      if(!r.c[4]||!r.c[11]?.v) return;
      if(r.c[3].v!==currentMonth) return;
      const date=new Date(Math.round((r.c[1].v-25569)*86400*1000));
      const wk=Math.min(4,Math.ceil(date.getDate()/7))-1;
      weeks[wk]+=Math.abs(r.c[4].v);
    });
    chart.data.labels=["W1","W2","W3","W4","W5"];
    chart.data.datasets[0].data=weeks;
    chart.update();
    chartCaption.innerText="Weekly expense trend (current month)";
  }

  function showYTD(){
    const months=Array(12).fill(0);
    rows.forEach(r=>{
      if(!r.c[4]||!r.c[11]?.v) return;
      const m=parseInt(r.c[3].v.slice(5,7))-1;
      months[m]+=Math.abs(r.c[4].v);
    });
    chart.data.labels=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    chart.data.datasets[0].data=months;
    chart.update();
    chartCaption.innerText="Monthly expense trend (YTD)";
  }

  showMonth();

  btnMonth.onclick=()=>{
    btnMonth.classList.add("active");
    btnYTD.classList.remove("active");
    showMonth();
  };

  btnYTD.onclick=()=>{
    btnYTD.classList.add("active");
    btnMonth.classList.remove("active");
    showYTD();
  };
});
</script>

</body>
</html>
