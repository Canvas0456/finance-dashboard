<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kaiwalya‚Äôs Finance Dashboard</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="theme-color" content="#0b0d12">

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>

<style>
/* =========================
   APPLE iOS-26 FINANCE THEME
   ========================= */

:root {
  --bg-main: #0b0d12;
  --bg-glass: rgba(255,255,255,0.08);
  --bg-card: rgba(255,255,255,0.06);

  --text-main: #f5f5f7;
  --text-muted: #9da0a6;

  --accent-blue: #0a84ff;
  --accent-green: #30d158;
  --accent-red: #ff453a;
  --accent-orange: #ff9f0a;

  --radius-xl: 26px;
  --radius-lg: 20px;
  --blur: blur(22px);

  --shadow-soft:
    inset 0 1px 0 rgba(255,255,255,0.08),
    0 20px 40px rgba(0,0,0,0.45);
}

* {
  box-sizing: border-box;
  font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Inter, sans-serif;
}

body {
  margin: 0;
  background: radial-gradient(circle at top, #121520, #06070b);
  color: var(--text-main);
  min-height: 100vh;
  overflow-x: hidden;
}

/* GLASS CARD */
.card {
  background: var(--bg-glass);
  backdrop-filter: var(--blur);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-soft);
  padding: 20px;
}

/* SECTION TITLES */
.section-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--text-main);
  margin: 24px 0 12px;
}

/* BUTTONS */
button {
  border: none;
  cursor: pointer;
  background: none;
  color: inherit;
}

/* HIDDEN */
.hidden {
  display: none !important;
}
</style>
</head>

<body>
<!-- =========================
     LOGIN / FACE ID SCREEN
     ========================= -->

<div id="lockScreen" class="card" style="
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
">

  <div style="
    width: 340px;
    text-align: center;
  ">

    <!-- FACE ID ICON -->
    <div id="faceIcon" style="
      width: 90px;
      height: 90px;
      margin: 0 auto 20px;
      border-radius: 24px;
      background: linear-gradient(145deg,#1c1f2b,#0c0e14);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 42px;
      box-shadow: var(--shadow-soft);
      transition: transform .6s ease, background .6s ease;
    ">
      üòä
    </div>

    <!-- TITLE -->
    <h2 style="margin: 0 0 6px;">Kaiwalya</h2>
    <p style="margin: 0 0 22px; color: var(--text-muted); font-size: 14px;">
      Face ID or Password
    </p>

    <!-- USER ID -->
    <input id="userIdInput" placeholder="User ID"
      style="
        width: 100%;
        padding: 14px;
        border-radius: 14px;
        border: none;
        margin-bottom: 12px;
        background: rgba(255,255,255,0.08);
        color: white;
        outline: none;
      ">

    <!-- PASSWORD -->
    <input id="passwordInput" type="password" placeholder="Password"
      style="
        width: 100%;
        padding: 14px;
        border-radius: 14px;
        border: none;
        margin-bottom: 18px;
        background: rgba(255,255,255,0.08);
        color: white;
        outline: none;
      ">

    <!-- LOGIN BUTTON -->
    <button onclick="attemptLogin()" style="
      width: 100%;
      padding: 14px;
      border-radius: 16px;
      background: var(--accent-blue);
      color: white;
      font-weight: 600;
      box-shadow: 0 10px 30px rgba(10,132,255,.4);
    ">
      Unlock
    </button>

    <!-- ERROR -->
    <div id="loginError" style="
      margin-top: 14px;
      font-size: 13px;
      color: var(--accent-red);
      display: none;
    ">
      Invalid credentials
    </div>

  </div>
</div>

<script>
/* =========================
   LOGIN + FACE ID LOGIC
   ========================= */

const VALID_USER = "Kaiwalya";
const VALID_PASS = "1234555";

function attemptLogin() {
  const user = document.getElementById("userIdInput").value.trim();
  const pass = document.getElementById("passwordInput").value.trim();
  const face = document.getElementById("faceIcon");
  const error = document.getElementById("loginError");

  error.style.display = "none";

  if (user === VALID_USER && pass === VALID_PASS) {
    // Face ID success animation
    face.style.transform = "scale(1.2)";
    face.style.background = "linear-gradient(145deg,#30d158,#0f5)";
    face.innerText = "üîì";

    setTimeout(() => {
      document.getElementById("lockScreen").style.opacity = "0";
      document.getElementById("lockScreen").style.pointerEvents = "none";
      setTimeout(() => {
        document.getElementById("lockScreen").remove();
      }, 600);
    }, 600);

  } else {
    error.style.display = "block";
    face.style.transform = "scale(.9)";
    face.innerText = "üòê";
    setTimeout(() => {
      face.style.transform = "scale(1)";
    }, 300);
  }
}
</script>
<!-- =========================
     APP SHELL
     ========================= -->

<div id="appShell" style="
  opacity: 1;
  transition: opacity .6s ease;
">

  <!-- FIXED HEADER -->
  <header style="
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(18px);
    background: linear-gradient(
      to bottom,
      rgba(15,17,26,.92),
      rgba(15,17,26,.75)
    );
    border-bottom: 1px solid rgba(255,255,255,.06);
  ">
    <div class="container" style="
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 18px 0;
    ">

      <!-- TITLE -->
      <div>
        <h1 style="margin:0;">Kaiwalya‚Äôs Finance Dashboard</h1>
        <div style="
          font-size: 13px;
          color: var(--text-muted);
          margin-top: 4px;
        ">
          Clarity over cash. Control over chaos.
        </div>
      </div>

      <!-- DATE + PERIOD -->
      <div style="text-align:right;">
        <div id="todayDate" style="
          font-size: 13px;
          color: var(--text-muted);
        ">
          <!-- JS inject -->
        </div>
        <div id="selectedPeriod" style="
          font-size: 14px;
          font-weight: 600;
          margin-top: 4px;
        ">
          <!-- JS inject -->
        </div>
      </div>

    </div>

    <!-- TOGGLES -->
    <div class="container" style="
      display: flex;
      gap: 10px;
      padding-bottom: 14px;
    ">
      <button id="toggleMonth"
        onclick="setView('MONTH')"
        style="
          padding: 8px 16px;
          border-radius: 999px;
          background: var(--accent-blue);
          color: white;
          font-weight: 600;
        ">
        Month
      </button>

      <button id="toggleYTD"
        onclick="setView('YTD')"
        style="
          padding: 8px 16px;
          border-radius: 999px;
          background: rgba(255,255,255,.08);
          color: var(--text-muted);
          font-weight: 600;
        ">
        YTD
      </button>
    </div>
  </header>

  <!-- MAIN CONTENT WRAPPER -->
  <main class="container" id="mainContent" style="
    padding-top: 26px;
    padding-bottom: 120px;
  ">
    <!-- NEXT PARTS WILL RENDER HERE -->
  </main>

</div>

<script>
/* =========================
   HEADER + TOGGLE LOGIC
   ========================= */

let CURRENT_VIEW = "MONTH";

function setView(view) {
  CURRENT_VIEW = view;

  const mBtn = document.getElementById("toggleMonth");
  const yBtn = document.getElementById("toggleYTD");

  if (view === "MONTH") {
    mBtn.style.background = "var(--accent-blue)";
    mBtn.style.color = "#fff";
    yBtn.style.background = "rgba(255,255,255,.08)";
    yBtn.style.color = "var(--text-muted)";
  } else {
    yBtn.style.background = "var(--accent-blue)";
    yBtn.style.color = "#fff";
    mBtn.style.background = "rgba(255,255,255,.08)";
    mBtn.style.color = "var(--text-muted)";
  }

  updatePeriodLabel();
  // Future: refresh charts & KPIs here
}

/* DATE + PERIOD */
function updatePeriodLabel() {
  const now = new Date();

  const options = { month: 'long', year: 'numeric' };
  const monthLabel = now.toLocaleDateString(undefined, options);

  document.getElementById("todayDate").innerText =
    now.toLocaleDateString(undefined, {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });

  document.getElementById("selectedPeriod").innerText =
    CURRENT_VIEW === "MONTH"
      ? `MONTH ¬∑ ${monthLabel}`
      : `YTD ¬∑ ${now.getFullYear()}`;
}

updatePeriodLabel();
</script>
<!-- =========================
     KPI SECTION
     ========================= -->

<section id="kpiSection" style="margin-top: 22px;">
  <div class="grid grid-4">

    <div class="card kpi">
      <div class="kpi-label">Total Balance</div>
      <div class="kpi-value" id="kpiBalance">‚Äî</div>
    </div>

    <div class="card kpi">
      <div class="kpi-label">Total Expenses</div>
      <div class="kpi-value" id="kpiExpenses">‚Äî</div>
    </div>

    <div class="card kpi">
      <div class="kpi-label">Budget Burn %</div>
      <div class="kpi-value" id="kpiBurn">‚Äî</div>
    </div>

    <div class="card kpi">
      <div class="kpi-label">Budget Remaining</div>
      <div class="kpi-value" id="kpiRemaining">‚Äî</div>
    </div>

  </div>
</section>

<style>
/* KPI styling */
.kpi {
  padding: 22px;
  min-height: 110px;
}

.kpi-label {
  font-size: 13px;
  color: var(--text-muted);
  margin-bottom: 8px;
}

.kpi-value {
  font-size: 28px;
  font-weight: 700;
  letter-spacing: .3px;
}
</style>

<script>
/* =========================
   GOOGLE SHEETS CONFIG
   ========================= */

const SHEET_ID = "1ApiV5dmKYycVw2IEnVKkNHY2ssLcOZZ1v1slU57UqM0";

/*
Dashboard_KPIs sheet structure:
Column A: KPI
Column B: Value
*/

const KPI_SHEET_NAME = "Dashboard_KPIs";

/* =========================
   FETCH KPI DATA
   ========================= */

async function fetchKPIs() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${KPI_SHEET_NAME}&tqx=out:json`;

  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.substr(47).slice(0, -2));

  const rows = json.table.rows;

  const map = {};
  rows.forEach(r => {
    if (!r.c[0] || !r.c[1]) return;
    map[r.c[0].v] = r.c[1].v;
  });

  renderKPIs(map);
}

/* =========================
   RENDER KPI VALUES
   ========================= */

function renderKPIs(data) {
  document.getElementById("kpiBalance").innerText =
    "‚Çπ" + Number(data["Total Balance (All Accounts)"] || 0).toLocaleString();

  document.getElementById("kpiExpenses").innerText =
    "‚Çπ" + Number(data["Current Month Expenses"] || 0).toLocaleString();

  document.getElementById("kpiBurn").innerText =
    ((Number(data["Budget Used %"] || 0) * 100).toFixed(2)) + "%";

  document.getElementById("kpiRemaining").innerText =
    "‚Çπ" + Number(data["Budget Remaining"] || 0).toLocaleString();
}

/* =========================
   INIT
   ========================= */

fetchKPIs();
</script>
<!-- =========================
     BUDGET UTILISATION
     ========================= -->

<section style="margin-top: 26px;">
  <div class="card">

    <!-- BAR -->
    <div style="
      width: 100%;
      height: 16px;
      border-radius: 999px;
      background: rgba(255,255,255,0.12);
      overflow: hidden;
    ">
      <div id="budgetBarFill" style="
        height: 100%;
        width: 0%;
        background: linear-gradient(
          90deg,
          #0a84ff,
          #30d158
        );
        border-radius: 999px;
        transition: width 1.2s ease;
      "></div>
    </div>

    <!-- LABELS -->
    <div style="
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 13px;
      color: var(--text-muted);
    ">
      <span id="budgetUsedLabel">Used ‚Äî</span>
      <span id="budgetRemainLabel">Remaining ‚Äî</span>
    </div>

  </div>
</section>

<script>
/* =========================
   BUDGET BAR LOGIC
   ========================= */

/*
Budget_vs_Actual sheet:
A: Month (yyyy-mm)
B: Category
C: Budget_Amount
D: Actual_Amount
*/

async function loadBudgetBar() {
  const sheet = "Budget_vs_Actual";
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${sheet}&tqx=out:json`;

  const res = await fetch(url);
  const text = await res.text();
  const json = JSON.parse(text.substr(47).slice(0, -2));

  const rows = json.table.rows;
  const now = new Date();

  let totalBudget = 0;
  let totalActual = 0;

  rows.forEach(r => {
    if (!r.c[0] || !r.c[2] || !r.c[3]) return;

    const rowMonth = r.c[0].v; // yyyy-mm
    const budget = Number(r.c[2].v || 0);
    const actual = Number(r.c[3].v || 0);

    if (CURRENT_VIEW === "MONTH") {
      const currentMonth =
        now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, "0");
      if (rowMonth !== currentMonth) return;
    }

    if (CURRENT_VIEW === "YTD") {
      if (!rowMonth.startsWith(String(now.getFullYear()))) return;
    }

    totalBudget += budget;
    totalActual += actual;
  });

  const usedPct =
    totalBudget === 0 ? 0 : Math.min((totalActual / totalBudget) * 100, 100);

  document.getElementById("budgetBarFill").style.width =
    usedPct.toFixed(2) + "%";

  document.getElementById("budgetUsedLabel").innerText =
    `Used ‚Çπ${totalActual.toLocaleString()}`;

  document.getElementById("budgetRemainLabel").innerText =
    `Remaining ‚Çπ${Math.max(totalBudget - totalActual, 0).toLocaleString()}`;
}

/* =========================
   AUTO REFRESH ON TOGGLE
   ========================= */

const originalSetView = setView;
setView = function(view) {
  originalSetView(view);
  loadBudgetBar();
};

loadBudgetBar();
        </script>

  <!-- =========================
     EXPENSE TREND
     ========================= -->

<section style="margin-top:28px;">
  <div class="card">
    <div class="section-title">Expense Trend</div>
    <canvas id="expenseTrendChart" height="220"></canvas>
  </div>
</section>

<script>
/* =========================
   EXPENSE TREND ENGINE
   ========================= */

let expenseChart;

/* ---- Helpers ---- */
function yyyyMM(d){
  return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0");
}
function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
function startOfYear(d){ return new Date(d.getFullYear(), 0, 1); }
function weekOfMonth(d){
  const first = new Date(d.getFullYear(), d.getMonth(), 1);
  return Math.ceil((d.getDate() + first.getDay()) / 7);
}

/* ---- Load & Build ---- */
async function loadExpenseTrend(){
  const sheet = "Txn_Clean";
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${sheet}&tqx=out:json`;
  const res = await fetch(url);
  const txt = await res.text();
  const json = JSON.parse(txt.substr(47).slice(0,-2));
  const rows = json.table.rows || [];

  const now = new Date();
  let labels = [];
  let actual = [];
  let forecast = [];

  if (CURRENT_VIEW === "MONTH"){
    // Weekly aggregation (current month)
    const map = {};
    rows.forEach(r=>{
      if (!r.c || !r.c[1] || !r.c[9]) return; // Txn_Date, Signed_Amount
      const d = new Date(r.c[1].v);
      if (d.getFullYear()!==now.getFullYear() || d.getMonth()!==now.getMonth()) return;
      const amt = Number(r.c[9].v || 0);
      if (amt >= 0) return; // expenses only
      const w = "W" + weekOfMonth(d);
      map[w] = (map[w] || 0) + Math.abs(amt);
    });
    labels = Object.keys(map);
    actual = labels.map(l=>map[l]);
    forecast = []; // no forecast in Month view
  } else {
    // YTD monthly aggregation + simple forecast
    const map = {};
    rows.forEach(r=>{
      if (!r.c || !r.c[1] || !r.c[9]) return;
      const d = new Date(r.c[1].v);
      if (d < startOfYear(now) || d > now) return;
      const amt = Number(r.c[9].v || 0);
      if (amt >= 0) return;
      const m = yyyyMM(d);
      map[m] = (map[m] || 0) + Math.abs(amt);
    });

    labels = Object.keys(map).sort();
    actual = labels.map(l=>map[l]);

    // Forecast next 1 month using simple average
    if (actual.length >= 2){
      const avg = actual.reduce((a,b)=>a+b,0)/actual.length;
      labels = [...labels, "Forecast"];
      forecast = [...actual.map(()=>null), avg];
      actual.push(null);
    }
  }

  renderExpenseChart(labels, actual, forecast);
}

/* ---- Render Chart ---- */
function renderExpenseChart(labels, actual, forecast){
  const ctx = document.getElementById("expenseTrendChart").getContext("2d");
  if (expenseChart) expenseChart.destroy();

  expenseChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "Actual",
          data: actual,
          borderColor: "#0a84ff",
          backgroundColor: "rgba(10,132,255,.25)",
          tension: .35,
          fill: true,
          pointRadius: 3
        },
        {
          label: "Forecast",
          data: forecast,
          borderColor: "#9da0a6",
          borderDash: [6,6],
          tension: .35,
          fill: false,
          pointRadius: 0
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: c => "‚Çπ" + Number(c.raw || 0).toLocaleString("en-IN")
          }
        }
      },
      scales: {
        x: {
          grid: { display: false },
          ticks: { color: "#9da0a6" }
        },
        y: {
          grid: { color: "rgba(255,255,255,.06)" },
          ticks: {
            color: "#9da0a6",
            callback: v => "‚Çπ" + v/1000 + "k"
          }
        }
      }
    }
  });
}

/* ---- Refresh on toggle ---- */
const _setView6 = setView;
setView = function(v){
  _setView6(v);
  loadExpenseTrend();
};

loadExpenseTrend();
        </script>

  <!-- =========================
     CATEGORY EXPENSES
     ========================= -->

<section style="margin-top:28px;">
  <div class="card">

    <div class="section-title">Expense Categories</div>

    <div style="
      display: grid;
      grid-template-columns: 220px 1fr;
      gap: 22px;
      align-items: center;
    ">

      <!-- DONUT -->
      <canvas id="categoryDonut" width="220" height="220"></canvas>

      <!-- LIST -->
      <div id="categoryList"></div>

    </div>

  </div>
</section>

<style>
.category-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid rgba(255,255,255,.06);
  font-size: 14px;
}

.category-name {
  color: var(--text-main);
}

.category-amt {
  font-weight: 600;
}

.category-over {
  color: var(--accent-red);
}

.category-ok {
  color: var(--accent-green);
}
</style>

<script>
/* =========================
   CATEGORY ENGINE
   ========================= */

let categoryChart;

async function loadCategories() {
  const now = new Date();
  const currentMonth =
    now.getFullYear() + "-" + String(now.getMonth() + 1).padStart(2, "0");

  /* -------- FETCH ACTUALS -------- */
  const actualUrl =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Category_Monthly_Actuals&tqx=out:json`;
  const actualRes = await fetch(actualUrl);
  const actualTxt = await actualRes.text();
  const actualJson = JSON.parse(actualTxt.substr(47).slice(0, -2));
  const actualRows = actualJson.table.rows;

  /* -------- FETCH BUDGETS -------- */
  const budgetUrl =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Budgets_Month&tqx=out:json`;
  const budgetRes = await fetch(budgetUrl);
  const budgetTxt = await budgetRes.text();
  const budgetJson = JSON.parse(budgetTxt.substr(47).slice(0, -2));
  const budgetRows = budgetJson.table.rows;

  const actualMap = {};
  actualRows.forEach(r => {
    if (!r.c[0] || !r.c[1] || !r.c[2]) return;
    if (r.c[0].v !== currentMonth) return;
    actualMap[r.c[1].v] = Number(r.c[2].v || 0);
  });

  const budgetMap = {};
  budgetRows.forEach(r => {
    if (!r.c[0] || !r.c[1] || !r.c[2]) return;
    if (r.c[0].v !== currentMonth) return;
    budgetMap[r.c[1].v] = Number(r.c[2].v || 0);
  });

  const labels = Object.keys(actualMap);
  const values = labels.map(l => actualMap[l]);
  const total = values.reduce((a, b) => a + b, 0);

  renderCategoryDonut(labels, values);
  renderCategoryList(labels, actualMap, budgetMap, total);
}

/* -------- DONUT -------- */
function renderCategoryDonut(labels, values) {
  const ctx = document.getElementById("categoryDonut").getContext("2d");
  if (categoryChart) categoryChart.destroy();

  categoryChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: [
          "#0a84ff",
          "#30d158",
          "#ff9f0a",
          "#bf5af2",
          "#64d2ff",
          "#ff453a",
          "#ffd60a"
        ]
      }]
    },
    options: {
      cutout: "70%",
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: c => `${c.label}: ‚Çπ${c.raw.toLocaleString("en-IN")}`
          }
        }
      }
    }
  });
}

/* -------- LIST -------- */
function renderCategoryList(labels, actualMap, budgetMap, total) {
  const box = document.getElementById("categoryList");
  box.innerHTML = "";

  labels.forEach(cat => {
    const actual = actualMap[cat];
    const budget = budgetMap[cat] || 0;
    const over = actual > budget && budget > 0;

    const row = document.createElement("div");
    row.className = "category-row";

    row.innerHTML = `
      <div class="category-name">${cat}</div>
      <div class="category-amt ${over ? "category-over" : "category-ok"}">
        ‚Çπ${actual.toLocaleString("en-IN")}
        <span style="color:var(--text-muted); font-size:12px;">
          (${((actual / total) * 100).toFixed(1)}%)
        </span>
      </div>
    `;

    box.appendChild(row);
  });
}

/* -------- TOGGLE REFRESH -------- */
const _setView7 = setView;
setView = function(v) {
  _setView7(v);
  loadCategories();
};

loadCategories();
</script>

  <!-- =========================
     EMI SECTION
     ========================= -->

<section style="margin-top:28px;">
  <div class="card">
    <div class="section-title">EMI Commitments</div>

    <div id="emiGrid" style="
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(220px,1fr));
      gap:16px;
    "></div>
  </div>
</section>

<style>
.emi-card {
  padding: 16px;
  border-radius: var(--radius-lg);
  background: rgba(255,255,255,.06);
}

.emi-name {
  font-weight: 600;
  margin-bottom: 6px;
}

.emi-amt {
  font-size: 20px;
  font-weight: 700;
}

.emi-meta {
  font-size: 12px;
  color: var(--text-muted);
  margin-top: 6px;
}

.emi-danger { color: var(--accent-red); }
.emi-warn   { color: var(--accent-orange); }
.emi-ok     { color: var(--accent-green); }

.emi-bar {
  height: 6px;
  border-radius: 999px;
  background: rgba(255,255,255,.12);
  overflow: hidden;
  margin-top: 10px;
}

.emi-fill {
  height: 100%;
  background: linear-gradient(90deg,#0a84ff,#30d158);
}
</style>

<script>
/* =========================
   EMI ENGINE
================================
Expected EMI_Master columns:
A EMI_Name
C Total_Months
D Monthly_Amount
E Due_Day (1-31)
F Months_Paid
G Months_Remaining
H Status (ONGOING ‚è≥ / COMPLETED ‚úÖ)
*/

async function loadEMIs(){
  const url =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=EMI_Master&tqx=out:json`;
  const res = await fetch(url);
  const txt = await res.text();
  const json = JSON.parse(txt.substr(47).slice(0,-2));
  const rows = json.table.rows || [];

  const grid = document.getElementById("emiGrid");
  grid.innerHTML = "";

  const today = new Date();

  rows.forEach(r=>{
    if (!r.c || !r.c[0] || !r.c[7]) return;
    if (r.c[7].v !== "ONGOING ‚è≥") return;

    const name = r.c[0].v;
    const total = Number(r.c[2]?.v || 0);
    const monthly = Number(r.c[3]?.v || 0);
    const dueDay = Number(r.c[4]?.v || 1);
    const paid = Number(r.c[5]?.v || 0);
    const remaining = Number(r.c[6]?.v || 0);

    /* Next due date */
    let due = new Date(today.getFullYear(), today.getMonth(), dueDay);
    if (due < today) due = new Date(today.getFullYear(), today.getMonth()+1, dueDay);

    const daysLeft = Math.ceil((due - today)/(1000*60*60*24));

    /* Stress */
    let stressClass = "emi-ok";
    let stressText = "On track";
    if (daysLeft <= 5) {
      stressClass = "emi-danger";
      stressText = "Due very soon";
    } else if (daysLeft <= 10) {
      stressClass = "emi-warn";
      stressText = "Upcoming";
    }

    const progress = total ? Math.min((paid/total)*100,100) : 0;

    const card = document.createElement("div");
    card.className = "emi-card";

    card.innerHTML = `
      <div class="emi-name">${name}</div>
      <div class="emi-amt">‚Çπ${monthly.toLocaleString("en-IN")}</div>

      <div class="emi-meta">
        ${remaining} months remaining ¬∑ Due in
        <span class="${stressClass}">${daysLeft} days</span>
      </div>

      <div class="emi-meta ${stressClass}">
        ${stressText}
      </div>

      <div class="emi-bar">
        <div class="emi-fill" style="width:${progress.toFixed(1)}%"></div>
      </div>

      <div class="emi-meta">
        Paid ${paid}/${total} months
      </div>
    `;

    grid.appendChild(card);
  });

  if (!grid.children.length){
    grid.innerHTML = `
      <div class="emi-meta">No active EMIs üéâ</div>
    `;
  }
}

/* Refresh-safe */
loadEMIs();
</script>
<!-- =========================
     AI INSIGHTS
     ========================= -->

<section style="margin-top:28px;">
  <div class="card">
    <div class="section-title">AI Insights</div>
    <div id="aiInsights" style="
      display:flex;
      flex-direction:column;
      gap:14px;
    "></div>
  </div>
</section>

<style>
.insight {
  padding: 14px 16px;
  border-radius: var(--radius-lg);
  background: rgba(255,255,255,.06);
  border-left: 5px solid transparent;
}

.insight-title {
  font-weight: 600;
  margin-bottom: 4px;
}

.insight-text {
  font-size: 14px;
  color: var(--text-muted);
}

.insight-action {
  margin-top: 6px;
  font-size: 13px;
  color: var(--accent-blue);
}

.insight.high   { border-color: var(--accent-red); }
.insight.medium { border-color: var(--accent-orange); }
.insight.low    { border-color: var(--accent-green); }
</style>

<script>
/* =========================
   AI INSIGHT ENGINE
================================ */

async function loadAIInsights(){
  const box = document.getElementById("aiInsights");
  box.innerHTML = "";

  const insights = [];

  /* -------- LOW BALANCE RISK -------- */
  const accUrl =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Account_Balances_Live&tqx=out:json`;
  const accRes = await fetch(accUrl);
  const accTxt = await accRes.text();
  const accJson = JSON.parse(accTxt.substr(47).slice(0,-2));
  const accRows = accJson.table.rows || [];

  accRows.forEach(r=>{
    if (!r.c || !r.c[0] || !r.c[4]) return;
    const name = r.c[0].v;
    const bal = Number(r.c[4].v || 0);
    const safe = Number(r.c[5]?.v || 1500);

    if (bal < safe){
      insights.push({
        level: bal <= 0 ? "high" : "medium",
        title: `Low balance ‚Äì ${name}`,
        text: `Available balance ‚Çπ${bal.toLocaleString("en-IN")} is below safe level ‚Çπ${safe.toLocaleString("en-IN")}.`,
        action: "Consider moving funds from another account."
      });
    }
  });

  /* -------- BUDGET OVERRUN -------- */
  const budUrl =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=Budget_vs_Actual&tqx=out:json`;
  const budRes = await fetch(budUrl);
  const budTxt = await budRes.text();
  const budJson = JSON.parse(budTxt.substr(47).slice(0,-2));
  const budRows = budJson.table.rows || [];

  const now = new Date();
  const currentMonth =
    now.getFullYear() + "-" + String(now.getMonth()+1).padStart(2,"0");

  budRows.forEach(r=>{
    if (!r.c || !r.c[0] || !r.c[1] || !r.c[2] || !r.c[3]) return;
    if (CURRENT_VIEW === "MONTH" && r.c[0].v !== currentMonth) return;
    if (CURRENT_VIEW === "YTD" && !r.c[0].v.startsWith(String(now.getFullYear()))) return;

    const cat = r.c[1].v;
    const budget = Number(r.c[2].v || 0);
    const actual = Number(r.c[3].v || 0);

    if (actual > budget && budget > 0){
      insights.push({
        level: "medium",
        title: `Overspent ‚Äì ${cat}`,
        text: `Spent ‚Çπ${actual.toLocaleString("en-IN")} against budget ‚Çπ${budget.toLocaleString("en-IN")}.`,
        action: "Reduce discretionary spending in this category."
      });
    }
  });

  /* -------- EMI STRESS -------- */
  const emiUrl =
    `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=EMI_Master&tqx=out:json`;
  const emiRes = await fetch(emiUrl);
  const emiTxt = await emiRes.text();
  const emiJson = JSON.parse(emiTxt.substr(47).slice(0,-2));
  const emiRows = emiJson.table.rows || [];

  const today = new Date();

  emiRows.forEach(r=>{
    if (!r.c || !r.c[0] || r.c[7]?.v !== "ONGOING ‚è≥") return;

    const name = r.c[0].v;
    const amt = Number(r.c[3]?.v || 0);
    const dueDay = Number(r.c[4]?.v || 1);

    let due = new Date(today.getFullYear(), today.getMonth(), dueDay);
    if (due < today) due = new Date(today.getFullYear(), today.getMonth()+1, dueDay);

    const daysLeft = Math.ceil((due - today)/(1000*60*60*24));

    if (daysLeft <= 7){
      insights.push({
        level: "high",
        title: `Upcoming EMI ‚Äì ${name}`,
        text: `EMI of ‚Çπ${amt.toLocaleString("en-IN")} is due in ${daysLeft} days.`,
        action: "Ensure sufficient balance before due date."
      });
    }
  });

  /* -------- RENDER -------- */
  if (insights.length === 0){
    box.innerHTML = `
      <div class="insight low">
        <div class="insight-title">All clear üëç</div>
        <div class="insight-text">
          No financial risks detected right now.
        </div>
      </div>
    `;
    return;
  }

  insights.slice(0,4).forEach(i=>{
    const div = document.createElement("div");
    div.className = `insight ${i.level}`;
    div.innerHTML = `
      <div class="insight-title">${i.title}</div>
      <div class="insight-text">${i.text}</div>
      <div class="insight-action">${i.action}</div>
    `;
    box.appendChild(div);
  });
}

/* INIT */
loadAIInsights();
</script>

  <script>
/* =========================
   APP BOOTSTRAP SEQUENCE
   ========================= */

async function initApp() {
  console.log("üîµ Initialising Finance App‚Ä¶");

  try {
    await fetchKPIs();
    await loadBudgetBar();
    await loadExpenseTrend();
    await loadCategories();
    await loadEMIs();
    await loadAIInsights();

    console.log("‚úÖ App fully loaded");
  } catch (e) {
    console.error("‚ùå App load error", e);
  }
}

/* Hook login success ‚Üí app init */
const originalAttemptLogin = attemptLogin;
attemptLogin = function() {
  originalAttemptLogin();

  // If login succeeded, lock screen removed
  setTimeout(() => {
    if (!document.getElementById("lockScreen")) {
      initApp();
    }
  }, 700);
};
  </script>

  <script>
/* =========================
   GLOBAL REFRESH ON TOGGLE
   ========================= */

const originalSetViewFinal = setView;
setView = function(view) {
  originalSetViewFinal(view);

  fetchKPIs();
  loadBudgetBar();
  loadExpenseTrend();
  loadCategories();
  loadAIInsights();
};
  </script>

  <script>
/* =========================
   PWA INSTALL HANDLER
   ========================= */

let deferredPrompt;

window.addEventListener("beforeinstallprompt", e => {
  e.preventDefault();
  deferredPrompt = e;

  const btn = document.createElement("button");
  btn.innerText = "Install App";
  btn.style.cssText = `
    position: fixed;
    bottom: 18px;
    right: 18px;
    padding: 10px 16px;
    border-radius: 999px;
    background: var(--accent-blue);
    color: white;
    border: none;
    z-index: 999;
    box-shadow: 0 10px 30px rgba(10,132,255,.4);
  `;

  btn.onclick = async () => {
    deferredPrompt.prompt();
    await deferredPrompt.userChoice;
    deferredPrompt = null;
    btn.remove();
  };

  document.body.appendChild(btn);
});
  </script>

  <script>
/* =========================
   AUTO REFRESH (10 MIN)
   ========================= */
setInterval(() => {
  console.log("üîÅ Auto refresh");
  fetchKPIs();
  loadBudgetBar();
  loadExpenseTrend();
  loadCategories();
  loadAIInsights();
}, 10 * 60 * 1000);
  </script>

  </body>
</html>
  
  
  
