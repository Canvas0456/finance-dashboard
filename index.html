<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kaiwalya â€¢ Financial Intelligence</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
:root{
  --bg:#020617;
  --card:#020617;
  --border:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;

  --safe:#1e293b;
  --warn:#78350f;
  --risk:#7f1d1d;
  --positive:#064e3b;
}

*{box-sizing:border-box}

body{
  margin:0;
  background:radial-gradient(circle at top,#0f172a,#020617);
  font-family:system-ui,-apple-system;
  color:var(--text);
}

h1{text-align:center;margin:16px 0 4px;font-size:22px}
.sub{text-align:center;color:var(--muted);font-size:12px}

.section{padding:14px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px}

.card{
  background:var(--card);
  border-radius:16px;
  padding:14px;
  box-shadow:inset 0 0 0 1px var(--border);
}

.card h3{font-size:11px;margin:0 0 6px;color:var(--muted)}
.card p{font-size:22px;margin:0;font-weight:600}

.badge{
  font-size:11px;
  padding:4px 10px;
  border-radius:999px;
}

.safe{background:var(--safe)}
.warn{background:var(--warn)}
.risk{background:var(--risk)}

.alert{
  margin-top:10px;
  padding:12px;
  border-radius:14px;
  font-size:13px;
}

.alert.red{background:var(--risk)}
.alert.yellow{background:var(--warn)}
.alert.green{background:var(--positive)}

.chart{
  margin-top:10px;
  padding:10px;
  background:var(--card);
  border-radius:16px;
}
</style>
</head>
<body>
<h1>ğŸ’¸ Financial Intelligence</h1>
<div class="sub">Live â€¢ Calm â€¢ Actionable</div>

<div style="text-align:center;margin:8px">
  <button class="badge" onclick="setMode('MONTH')">Monthly</button>
  <button class="badge" onclick="setMode('WEEK')">Weekly</button>
</div>

<div class="section">
  <div class="grid" style="grid-template-columns:repeat(2,1fr)">
    <div class="card"><h3>Total Balance</h3><p id="kTotal">â€“</p></div>
    <div class="card"><h3>Net Cashflow</h3><p id="kNet">â€“</p></div>
    <div class="card"><h3>Cash Runway</h3><p id="kRunway">â€“</p></div>
    <div class="card"><h3>MoM Change</h3><p id="kMoM">â€“</p></div>
  </div>
</div>
<div class="section">
  <h3>ğŸ¦ Account Safety</h3>
  <div id="accounts" class="grid"></div>
</div>

<div class="section">
  <div class="grid">
    <div class="card">
      <h3>ğŸ’³ EMI Health</h3>
      <p id="kEmi">â€“</p>
      <small id="kEmiNote"></small>
    </div>
    <div class="card">
      <h3>ğŸ“¥ Receivables</h3>
      <p id="kRecv">â€“</p>
    </div>
    <div class="card">
      <h3>ğŸ“¤ Payables</h3>
      <p id="kPay">â€“</p>
    </div>
  </div>
</div>
<div class="section">
  <h3>ğŸ“Š Where money went</h3>
  <div id="donut" class="chart" style="height:260px"></div>
</div>

<div class="section">
  <h3>ğŸ“ˆ Spending Trend</h3>
  <div id="trend" class="chart" style="height:240px"></div>
</div>
<div class="section">
  <h3>ğŸ§  What needs attention</h3>
  <div id="insights"></div>
</div
<script>
google.charts.load("current",{packages:["corechart"]});
google.charts.setOnLoadCallback(init);

const SHEET_ID="1ApiV5dmKYycVw2IEnVKkNHY2ssLcOZZ1v1slU57UqM0";
let VIEW_MODE="MONTH";

function setMode(m){VIEW_MODE=m;init();}

function gviz(sheet){
  return fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${sheet}`)
    .then(r=>r.text())
    .then(t=>JSON.parse(t.substr(47).slice(0,-2)));
}
  async function init(){
  loadKPIs();
  loadAccounts();
  loadDonut();
  loadTrend();
  loadAI();
}

async function loadKPIs(){
  const d=await gviz("Dashboard_KPIs");
  const m={};
  d.table.rows.forEach(r=>m[r.c[0].v]=r.c[1]?.v||0);
  kTotal.innerText="â‚¹"+m["Total Balance (All Accounts)"];
  kNet.innerText="â‚¹"+m["Current Month Net Savings"];
  kMoM.innerText=(m["MoM %"]||0)+"%";
  kRunway.innerText=(m["Cash Runway (Days)"]||"â€“")+" days";
}

async function loadAccounts(){
  const d=await gviz("Account_Balances_Live");
  accounts.innerHTML="";
  d.table.rows.forEach(r=>{
    const bal=Number(r.c[4].v);
    let cls="safe",label="Safe";
    if(bal<0){cls="risk";label="Critical";}
    else if(bal<2000){cls="warn";label="Low";}
    accounts.innerHTML+=`
      <div class="card">
        <h3>${r.c[0].v}</h3>
        <p>${label}${label!=="Safe"?" â€¢ â‚¹"+bal:""}</p>
      </div>`;
  });
}

async function loadDonut(){
  const d=await gviz("Category_Monthly_Actuals");
  const data=new google.visualization.DataTable();
  data.addColumn("string","Category");
  data.addColumn("number","Amount");
  d.table.rows.forEach(r=>{
    if(Number(r.c[2].v)>0) data.addRow([r.c[1].v,Number(r.c[2].v)]);
  });
  if(data.getNumberOfRows())
    new google.visualization.PieChart(donut)
      .draw(data,{pieHole:0.65,legend:"none",backgroundColor:"transparent"});
}

async function loadTrend(){
  const d=await gviz("Finance_Monthly_Summary");
  const data=new google.visualization.DataTable();
  data.addColumn("string","Month");
  data.addColumn("number","Expenses");
  d.table.rows.forEach(r=>data.addRow([r.c[0].v,Number(r.c[2].v)]));
  new google.visualization.LineChart(trend)
    .draw(data,{backgroundColor:"transparent",legend:"none"});
}

async function loadAI(){
  const d=await gviz("AI_Insights");
  insights.innerHTML="";
  let shown=0;
  d.table.rows.forEach(r=>{
    if(!r.c[0].v || shown>=3) return;
    let cls=r.c[1].v==="HIGH"?"red":r.c[1].v==="MEDIUM"?"yellow":"green";
    insights.innerHTML+=`
      <div class="alert ${cls}">
        <strong>${r.c[2].v}</strong><br>
        ${r.c[3].v}<br>
        <em>${r.c[4].v}</em>
      </div>`;
    shown++;
  });
}
</script>
</body>
</html>
