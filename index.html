<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Kaiwalya â€“ Finance Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/charts/loader.js"></script>

<style>
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:#020617;
  color:#e5e7eb;
}
h1{text-align:center;margin:12px 0}
.section{padding:14px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px}
.card{background:#020617;border-radius:14px;padding:14px;box-shadow:inset 0 0 0 1px #1e293b}
.card h3{font-size:12px;color:#9ca3af;margin:0 0 6px}
.card p{font-size:20px;margin:0;font-weight:600}
.toggle{
  display:flex;gap:8px;justify-content:center;margin-bottom:12px
}
.toggle button{
  padding:8px 14px;
  border-radius:10px;
  border:1px solid #1e293b;
  background:#020617;
  color:#e5e7eb;
}
.toggle button.active{
  background:#2563eb;
  border-color:#2563eb;
}
select{
  background:#020617;
  color:#e5e7eb;
  border:1px solid #1e293b;
  padding:8px;
  border-radius:8px;
  width:100%;
}
</style>
</head>

<body>

<h1>ðŸ“Š Finance Dashboard</h1>

<!-- TOGGLE -->
<div class="toggle">
  <button id="btnWeekly">Weekly</button>
  <button id="btnMonthly" class="active">Monthly</button>
  <button id="btnYTD">YTD</button>
</div>

<!-- SLICERS -->
<div class="section" id="slicers">
  <select id="weekSelect" style="display:none"></select>
  <select id="monthSelect"></select>
</div>

<!-- KPI -->
<div class="section">
  <div class="grid">
    <div class="card"><h3>Income</h3><p id="kIncome">â€“</p></div>
    <div class="card"><h3>Expenses</h3><p id="kExpense">â€“</p></div>
    <div class="card"><h3>Net</h3><p id="kNet">â€“</p></div>
  </div>
</div>

<script>
google.charts.load("current",{packages:["corechart"]});
google.charts.setOnLoadCallback(init);

const SHEET_ID="1ApiV5dmKYycVw2IEnVKkNHY2ssLcOZZ1v1slU57UqM0";
let MODE="MONTHLY";

function gviz(sheet){
  return fetch(`https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${sheet}`)
    .then(r=>r.text())
    .then(t=>JSON.parse(t.substr(47).slice(0,-2)));
}

/* INIT */
async function init(){
  setupToggles();
  await loadMonthSlicer();
  refresh();
}

/* TOGGLES */
function setupToggles(){
  btnWeekly.onclick=()=>setMode("WEEKLY");
  btnMonthly.onclick=()=>setMode("MONTHLY");
  btnYTD.onclick=()=>setMode("YTD");
}

function setMode(m){
  MODE=m;
  document.querySelectorAll(".toggle button").forEach(b=>b.classList.remove("active"));
  document.getElementById("btn"+m.charAt(0)+m.slice(1).toLowerCase()).classList.add("active");

  weekSelect.style.display = m==="WEEKLY"?"block":"none";
  monthSelect.style.display = m==="MONTHLY"?"block":"none";

  refresh();
}

/* SLICERS */
async function loadMonthSlicer(){
  const d=await gviz("Finance_Monthly_Summary");
  monthSelect.innerHTML="";
  d.table.rows.forEach(r=>{
    const m=r.c[0].v;
    const opt=document.createElement("option");
    opt.value=m;
    opt.text=m;
    monthSelect.appendChild(opt);
  });
  monthSelect.onchange=refresh;
}

/* KPI LOGIC */
async function refresh(){
  if(MODE==="MONTHLY") loadMonthly();
  if(MODE==="YTD") loadYTD();
  if(MODE==="WEEKLY") loadWeekly();
}

async function loadMonthly(){
  const d=await gviz("Finance_Monthly_Summary");
  const sel=monthSelect.value;
  const r=d.table.rows.find(x=>x.c[0].v===sel);
  if(!r)return;
  kIncome.innerText=r.c[1].v;
  kExpense.innerText=r.c[2].v;
  kNet.innerText=r.c[4].v;
}

async function loadYTD(){
  const d=await gviz("Finance_Monthly_Summary");
  let inc=0,exp=0;
  d.table.rows.forEach(r=>{
    inc+=Number(r.c[1].v||0);
    exp+=Number(r.c[2].v||0);
  });
  kIncome.innerText=inc;
  kExpense.innerText=exp;
  kNet.innerText=inc-exp;
}

async function loadWeekly(){
  const d=await gviz("Txn_Clean");
  let exp=0;
  d.table.rows.forEach(r=>{
    if(r.c[10].v===true){
      exp+=Math.abs(r.c[8].v);
    }
  });
  kIncome.innerText="â€“";
  kExpense.innerText=exp;
  kNet.innerText=-exp;
}
</script>

</body>
</html>
