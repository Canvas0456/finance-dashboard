
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Kaiwalya ‚Ä¢ Finance Control</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --bg: #0b0f14;
  --glass: rgba(255,255,255,0.08);
  --glass-strong: rgba(255,255,255,0.14);
  --border: rgba(255,255,255,0.18);

  --text: #f9fafb;
  --muted: rgba(255,255,255,0.6);
  --dim: rgba(255,255,255,0.4);

  --blue: #5aa2ff;
  --teal: #3dd6c6;
  --amber: #fbbf24;
  --red: #ef4444;
  --green: #22c55e;

  --radius: 22px;
  --blur: blur(28px);
  --ease: cubic-bezier(0.4,0,0.2,1);
}

* { box-sizing: border-box; margin:0; padding:0; }

body {
  font-family: Inter, system-ui;
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(90,162,255,.18), transparent),
    radial-gradient(900px 500px at 90% 10%, rgba(61,214,198,.14), transparent),
    var(--bg);
  color: var(--text);
  min-height: 100vh;
}

.container {
  max-width: 1200px;
  margin: auto;
  padding: 26px 22px;
}

.glass {
  background: linear-gradient(180deg, var(--glass-strong), var(--glass));
  backdrop-filter: var(--blur);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 22px;
  box-shadow: 0 20px 50px rgba(0,0,0,.5);
  transition: transform .6s var(--ease);
}

.glass:hover {
  transform: translateY(-4px);
}

.h1 { font-size: 26px; font-weight: 700; }
.h2 { font-size: 18px; font-weight: 600; }
.sub { color: var(--muted); font-size: 14px; }
.muted { color: var(--dim); font-size: 13px; }

.btn {
  border-radius: 999px;
  padding: 10px 18px;
  border: 1px solid var(--border);
  background: var(--glass);
  color: var(--text);
  cursor: pointer;
  transition: .4s var(--ease);
}

.btn.active {
  background: linear-gradient(135deg, var(--blue), var(--teal));
  border: none;
}

.fade {
  animation: fade .8s var(--ease) forwards;
}

@keyframes fade {
  from { opacity:0; transform: translateY(10px); }
  to { opacity:1; transform:none; }
}
</style>
</head>

<body>

<!-- PARTS WILL BE ADDED BELOW -->

<script>
/* =========================================================
   üîå GOOGLE SHEETS LIVE DATA CONNECTOR
   (CRITICAL ‚Äì DO NOT MODIFY UNLESS ASKED)
========================================================= */

/*
Your Google Sheet ID
Confirmed and locked
*/
const SHEET_ID = "1ApiV5dmKYycVw2IEnVKkNHY2ssLcOZZ1v1slU57UqM0";

/*
IMPORTANT REQUIREMENTS (already satisfied by you):
‚úî File ‚Üí Share ‚Üí Publish to web
‚úî Entire document published
‚úî Anyone with link can view
*/

/*
This function fetches ANY sheet by name
Usage example:
fetchSheet("Txn_Clean")
*/
async function fetchSheet(sheetName) {
  try {
    const url =
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}&tqx=out:json`;

    const response = await fetch(url);
    const text = await response.text();

    // Google adds extra characters before JSON ‚Üí strip them
    const json = JSON.parse(text.substring(47).slice(0, -2));

    return json.table.rows || [];
  } catch (error) {
    console.error(`‚ùå Error loading sheet: ${sheetName}`, error);
    return [];
  }
}

/*
GLOBAL STATE
Used by Month / YTD toggle everywhere
*/
let MODE = "MONTH";

/*
Universal reload hook
Every section attaches to this
*/
function reloadAll() {
  console.log("üîÑ Reloading dashboard for mode:", MODE);
}

/*
Safety: auto-reload once page is fully ready
*/
window.addEventListener("load", () => {
  reloadAll();
});
</script>

   <!-- =========================================================
     üßä HERO HEADER
========================================================= -->
<header class="container fade">

  <div class="glass" style="
    display:grid;
    grid-template-columns: 1fr auto;
    gap: 18px;
    align-items: center;
  ">

    <!-- LEFT: TITLE + SUBTITLE + THOUGHT -->
    <div>
      <div class="h1">Kaiwalya‚Äôs Finance Dashboard</div>
      <div class="sub" style="margin-top:6px;">
        Calm clarity for everyday money decisions
      </div>

      <!-- Thought of the day -->
      <div id="thoughtBox" style="
        margin-top:14px;
        display:inline-block;
        padding:10px 16px;
        border-radius:999px;
        background: rgba(255,255,255,0.14);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border);
        font-size:13px;
        color: var(--muted);
      ">
        Loading thought of the day‚Ä¶
      </div>
    </div>

    <!-- RIGHT: DATE + TOGGLE -->
    <div style="text-align:right;">
      <div id="todayDate" class="muted" style="margin-bottom:10px;">
        ‚Äî
      </div>

      <div style="
        display:inline-flex;
        gap:6px;
        padding:6px;
        border-radius:999px;
        background: rgba(255,255,255,0.10);
        border: 1px solid var(--border);
      ">
        <button id="btnMonth" class="btn active"
          onclick="setMode('MONTH')">Month</button>
        <button id="btnYTD" class="btn"
          onclick="setMode('YTD')">YTD</button>
      </div>
    </div>

  </div>

</header>

<script>
/* =========================================================
   HEADER LOGIC
========================================================= */

/* ----- Today Date (fixed) ----- */
const now = new Date();
document.getElementById("todayDate").innerText =
  now.toLocaleDateString("en-IN", {
    weekday: "long",
    day: "numeric",
    month: "short",
    year: "numeric"
  });

/* ----- Toggle Logic (GLOBAL MODE) ----- */
function setMode(mode){
  MODE = mode;

  document.getElementById("btnMonth")
    .classList.toggle("active", mode === "MONTH");

  document.getElementById("btnYTD")
    .classList.toggle("active", mode === "YTD");

  reloadAll(); // üîÅ refresh everything
}

/* ----- Thought of the Day (Live Internet) ----- */
async function loadThought(){
  const el = document.getElementById("thoughtBox");
  try {
    const res = await fetch(
      "https://api.quotable.io/random?tags=wisdom|inspirational|life"
    );
    const data = await res.json();
    el.innerText = `‚Äú${data.content}‚Äù`;
  } catch {
    el.innerText =
      "Small calm decisions compound into financial peace.";
  }
}

loadThought();
</script>

   <!-- =========================================================
     üí∞ MONEY POSITION
========================================================= -->
<section class="container fade">

  <div class="glass">
    <div class="h2" style="margin-bottom:10px;">Money Position</div>
    <div class="sub" style="margin-bottom:16px;">
      A proportional view of where your money stands right now
    </div>

    <!-- STRIP -->
    <div style="
      display:flex;
      height:18px;
      border-radius:999px;
      overflow:hidden;
      background: rgba(255,255,255,0.08);
      border:1px solid var(--border);
    ">
      <div id="segBalance" style="width:0%; background:linear-gradient(90deg,var(--blue),var(--teal)); transition:width 1.2s var(--ease);"></div>
      <div id="segExpenses" style="width:0%; background:linear-gradient(90deg,var(--amber),#f59e0b); transition:width 1.2s var(--ease);"></div>
      <div id="segEMI" style="width:0%; background:linear-gradient(90deg,#fb7185,var(--red)); transition:width 1.2s var(--ease);"></div>
      <div id="segSavings" style="width:0%; background:linear-gradient(90deg,var(--green),#16a34a); transition:width 1.2s var(--ease);"></div>
    </div>

    <!-- VALUES -->
    <div style="
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
      gap:14px;
      margin-top:16px;
      font-size:13px;
    ">
      <div>
        <div class="muted">Total Balance</div>
        <div id="valBalance" style="font-weight:700;">‚Äî</div>
      </div>
      <div>
        <div class="muted">Expenses</div>
        <div id="valExpenses" style="font-weight:700;">‚Äî</div>
      </div>
      <div>
        <div class="muted">EMI Paid</div>
        <div id="valEMI" style="font-weight:700;">‚Äî</div>
      </div>
      <div>
        <div class="muted">Net Savings</div>
        <div id="valSavings" style="font-weight:700;">‚Äî</div>
      </div>
    </div>

  </div>

</section>

<script>
/* =========================================================
   MONEY POSITION ‚Äî DATA LOGIC
========================================================= */
async function loadMoneyPosition(){

  // Decide KPI sheet based on toggle
  const kpiSheet = MODE === "MONTH"
    ? "Dashboard_KPIs_Month"
    : "Dashboard_KPIs_YTD";

  const rows = await fetchSheet(kpiSheet);

  // Map KPI -> value
  const k = {};
  rows.forEach(r=>{
    const key = r.c[0]?.v;
    const val = Number(r.c[1]?.v) || 0;
    if(key) k[key] = val;
  });

  const balance = k["Total Balance (All Accounts)"] || 0;

  const expenses = MODE === "MONTH"
    ? k["Current Month Expenses"] || 0
    : k["YTD Expenses"] || 0;

  const emi = MODE === "MONTH"
    ? k["EMI Paid (Current Month)"] || 0
    : k["EMI Paid (YTD)"] || 0;

  const savings = MODE === "MONTH"
    ? k["Current Month Net Savings"] || 0
    : k["YTD Net Savings"] || 0;

  // Avoid divide-by-zero
  const total = Math.max(
    balance + expenses + emi + Math.abs(savings),
    1
  );

  // Percentages
  const pBal = (balance / total) * 100;
  const pExp = (expenses / total) * 100;
  const pEmi = (emi / total) * 100;
  const pSav = (Math.abs(savings) / total) * 100;

  // Animate bars
  document.getElementById("segBalance").style.width = pBal + "%";
  document.getElementById("segExpenses").style.width = pExp + "%";
  document.getElementById("segEMI").style.width = pEmi + "%";
  document.getElementById("segSavings").style.width = pSav + "%";

  // Numbers
  document.getElementById("valBalance").innerText =
    "‚Çπ" + balance.toLocaleString("en-IN");

  document.getElementById("valExpenses").innerText =
    "‚Çπ" + expenses.toLocaleString("en-IN");

  document.getElementById("valEMI").innerText =
    "‚Çπ" + emi.toLocaleString("en-IN");

  document.getElementById("valSavings").innerText =
    "‚Çπ" + savings.toLocaleString("en-IN");
}

/* Attach to global reload */
const _reload4 = reloadAll;
reloadAll = function(){
  _reload4();
  loadMoneyPosition();
};

/* Initial load */
loadMoneyPosition();
</script>

 <!-- =========================================================
     üìä BUDGET UTILISATION
========================================================= -->
<section class="container fade">

  <div class="glass">
    <div class="h2" style="margin-bottom:8px;">Budget Utilisation</div>
    <div id="budgetNarrative" class="sub" style="margin-bottom:14px;">
      ‚Äî
    </div>

    <!-- PROGRESS BAR -->
    <div style="
      position:relative;
      height:16px;
      border-radius:999px;
      overflow:hidden;
      background: rgba(255,255,255,0.08);
      border:1px solid var(--border);
      margin-bottom:10px;
    ">
      <!-- Actual -->
      <div id="budgetActualBar" style="
        position:absolute; left:0; top:0; height:100%;
        width:0%;
        background: linear-gradient(90deg, var(--amber), #f59e0b);
        transition: width 1.2s var(--ease);
      "></div>

      <!-- Planned Pace Marker -->
      <div id="budgetPaceMarker" style="
        position:absolute; top:-6px; height:28px; width:2px;
        background:#fff; opacity:.6; left:0%;
        transition:left 1.2s var(--ease);
      "></div>
    </div>

    <!-- METRICS -->
    <div style="
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(160px,1fr));
      gap:14px;
      font-size:13px;
    ">
      <div>
        <div class="muted">Budget Used</div>
        <div id="budgetUsedPct" style="font-weight:700;">‚Äî</div>
      </div>
      <div>
        <div class="muted">Budget Remaining</div>
        <div id="budgetRemaining" style="font-weight:700;">‚Äî</div>
      </div>
      <div>
        <div class="muted">Actual Spend</div>
        <div id="budgetActualVal" style="font-weight:700;">‚Äî</div>
      </div>
      <div>
        <div class="muted">Total Budget</div>
        <div id="budgetTotalVal" style="font-weight:700;">‚Äî</div>
      </div>
    </div>
  </div>

</section>

<script>
/* =========================================================
   BUDGET UTILISATION ‚Äî DATA LOGIC
========================================================= */
async function loadBudgetUtilisation(){
  const rows = await fetchSheet("Budget_vs_Actual");
  const now = new Date();
  const currentYM = now.toISOString().slice(0,7);

  let totalBudget = 0;
  let totalActual = 0;

  rows.forEach(r=>{
    const m = r.c[0]?.v;                 // Month (yyyy-mm)
    const budget = Number(r.c[2]?.v) || 0; // Budget_Amount
    const actual = Number(r.c[3]?.v) || 0; // Actual_Amount

    if(
      (MODE === "MONTH" && m === currentYM) ||
      (MODE === "YTD" && m <= currentYM)
    ){
      totalBudget += budget;
      totalActual += actual;
    }
  });

  const usedPct = totalBudget > 0 ? (totalActual / totalBudget) : 0;
  const remaining = Math.max(totalBudget - totalActual, 0);

  // Animate bar
  document.getElementById("budgetActualBar").style.width =
    Math.min(usedPct * 100, 100) + "%";

  // Planned pace (time-based)
  let pacePct = 0;
  if(MODE === "MONTH"){
    const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
    pacePct = (now.getDate() / daysInMonth) * 100;
  } else {
    const start = new Date(now.getFullYear(), 0, 1);
    const daysPassed = Math.max((now - start) / (1000*60*60*24), 1);
    pacePct = Math.min((daysPassed / 365) * 100, 100);
  }
  document.getElementById("budgetPaceMarker").style.left = pacePct + "%";

  // Numbers
  document.getElementById("budgetUsedPct").innerText =
    (usedPct * 100).toFixed(2) + "%";

  document.getElementById("budgetRemaining").innerText =
    "‚Çπ" + remaining.toLocaleString("en-IN");

  document.getElementById("budgetActualVal").innerText =
    "‚Çπ" + totalActual.toLocaleString("en-IN");

  document.getElementById("budgetTotalVal").innerText =
    "‚Çπ" + totalBudget.toLocaleString("en-IN");

  // Narrative
  const diff = totalActual - (totalBudget * (pacePct/100));
  const narrative = document.getElementById("budgetNarrative");

  if(diff > 0){
    narrative.innerText =
      `You are ahead of budget pace by ‚Çπ${Math.round(diff).toLocaleString("en-IN")}. Consider slowing discretionary spends.`;
  } else {
    narrative.innerText =
      `You are within budget pace with ‚Çπ${Math.round(Math.abs(diff)).toLocaleString("en-IN")} flexibility right now.`;
  }
}

/* Attach to global reload */
const _reload5 = reloadAll;
reloadAll = function(){
  _reload5();
  loadBudgetUtilisation();
};

/* Initial load */
loadBudgetUtilisation();
</script>

  <!-- =========================================================
     üìÖ SPENDING BEHAVIOUR + CATEGORIES
========================================================= -->
<section class="container fade">

  <div class="glass">

    <div class="h2" style="margin-bottom:8px;">Spending Behaviour</div>
    <div class="sub" style="margin-bottom:18px;">
      How expenses are distributed through time
    </div>

    <!-- WEEKLY RHYTHM -->
    <div id="weeklyGrid" style="
      display:grid;
      grid-template-columns: repeat(7, 1fr);
      gap:10px;
      margin-bottom:26px;
    ">
      <!-- injected -->
    </div>

    <hr style="border:none;border-top:1px solid var(--border);margin:18px 0;">

    <div class="h2" style="margin-bottom:8px;">Expense Categories</div>
    <div class="sub" style="margin-bottom:14px;">
      Ranked by actual spending impact
    </div>

    <!-- CATEGORY LIST -->
    <div id="categoryList" style="
      display:flex;
      flex-direction:column;
      gap:10px;
    ">
      <!-- injected -->
    </div>

  </div>

</section>

<script>
/* =========================================================
   SPENDING BEHAVIOUR + CATEGORY LOGIC
========================================================= */
async function loadSpendingAndCategories(){

  const txns = await fetchSheet("Txn_Clean");
  const catMonth = await fetchSheet("Category_Monthly_Actuals");

  const now = new Date();
  const currentYM = now.toISOString().slice(0,7);

  /* ---------- WEEKLY RHYTHM (Current Month only) ---------- */
  const weekly = [0,0,0,0,0,0,0]; // Mon ‚Üí Sun

  txns.forEach(r=>{
    const amt = Number(r.c[9]?.v) || 0;   // Signed_Amount
    const dateVal = r.c[1]?.v;            // Txn_Date
    const effMonth = r.c[3]?.v;            // Effective_Month

    if(!dateVal || amt >= 0) return;

    if(MODE === "MONTH" && effMonth !== currentYM) return;
    if(MODE === "YTD" && effMonth > currentYM) return;

    const d = new Date(dateVal);
    const day = (d.getDay() + 6) % 7; // Monday = 0
    weekly[day] += Math.abs(amt);
  });

  const maxDay = Math.max(...weekly, 1);
  const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  const grid = document.getElementById("weeklyGrid");
  grid.innerHTML = "";

  weekly.forEach((val,i)=>{
    const intensity = val / maxDay;
    const cell = document.createElement("div");

    cell.style.height = "64px";
    cell.style.borderRadius = "14px";
    cell.style.background =
      `rgba(251,191,36,${0.15 + intensity * 0.6})`;
    cell.style.display = "flex";
    cell.style.flexDirection = "column";
    cell.style.justifyContent = "center";
    cell.style.alignItems = "center";
    cell.style.fontSize = "12px";
    cell.style.transition = "0.6s var(--ease)";

    cell.innerHTML = `
      <div style="font-weight:600">${days[i]}</div>
      <div class="muted">‚Çπ${Math.round(val)}</div>
    `;
    grid.appendChild(cell);
  });

  /* ---------- CATEGORY RANKING ---------- */
  const categoryTotals = {};

  catMonth.forEach(r=>{
    const m = r.c[0]?.v;
    const cat = r.c[1]?.v;
    const amt = Number(r.c[2]?.v) || 0;

    if(!cat) return;

    if(
      (MODE === "MONTH" && m === currentYM) ||
      (MODE === "YTD" && m <= currentYM)
    ){
      categoryTotals[cat] = (categoryTotals[cat] || 0) + amt;
    }
  });

  const sorted = Object.entries(categoryTotals)
    .sort((a,b)=>b[1]-a[1]);

  const total = sorted.reduce((s,[,v])=>s+v,0) || 1;
  const list = document.getElementById("categoryList");
  list.innerHTML = "";

  sorted.forEach(([cat,amt],i)=>{
    const pct = Math.round((amt/total)*100);

    const row = document.createElement("div");
    row.style.display = "grid";
    row.style.gridTemplateColumns = "1fr auto auto";
    row.style.alignItems = "center";
    row.style.padding = "10px 14px";
    row.style.borderRadius = "14px";
    row.style.background = "rgba(255,255,255,0.08)";
    row.style.border = "1px solid var(--border)";

    row.innerHTML = `
      <div>
        <div style="font-weight:600">${cat}</div>
        <div class="muted">${pct}% of spend</div>
      </div>
      <div style="font-weight:600">
        ‚Çπ${Math.round(amt).toLocaleString("en-IN")}
      </div>
      <div class="muted">#${i+1}</div>
    `;

    list.appendChild(row);
  });

}

/* Attach to reload */
const _reload6 = reloadAll;
reloadAll = function(){
  _reload6();
  loadSpendingAndCategories();
};

/* Initial load */
loadSpendingAndCategories();
</script>

   
<!-- =========================================================
     üí≥ EMI STRESS METER
========================================================= -->
<section class="container fade">

  <div class="glass">

    <div class="h2" style="margin-bottom:8px;">EMI Stress</div>
    <div class="sub" style="margin-bottom:16px;">
      Ongoing obligations and financial pressure
    </div>

    <!-- SUMMARY -->
    <div style="
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap:14px;
      margin-bottom:18px;
    ">
      <div>
        <div class="muted">Monthly EMI</div>
        <div id="emiMonthly" style="font-weight:700;font-size:18px;">‚Äî</div>
      </div>
      <div>
        <div class="muted">Remaining Liability</div>
        <div id="emiRemaining" style="font-weight:700;font-size:18px;">‚Äî</div>
      </div>
      <div>
        <div class="muted">Pressure Level</div>
        <div id="emiPressureText" style="font-weight:700;font-size:16px;">‚Äî</div>
      </div>
    </div>

    <!-- STRESS BAR -->
    <div style="
      position:relative;
      height:16px;
      border-radius:999px;
      overflow:hidden;
      background: rgba(255,255,255,0.08);
      border:1px solid var(--border);
    ">
      <div id="emiStressBar" style="
        height:100%;
        width:0%;
        background: linear-gradient(
          90deg,
          var(--green),
          var(--amber),
          var(--red)
        );
        transition: width 1.2s var(--ease);
      "></div>
    </div>

    <div class="muted" style="margin-top:8px;font-size:12px;">
      Ideal EMI ‚â§ 30% of income
    </div>

  </div>

</section>

<script>
/* =========================================================
   EMI STRESS ‚Äî DATA LOGIC
========================================================= */
async function loadEMIStress(){

  const emiMaster = await fetchSheet("EMI_Master");
  const emiPaid = await fetchSheet("EMI_Paid_Summary");

  const paidMap = {};
  emiPaid.forEach(r=>{
    const name = r.c[0]?.v;
    const monthsPaid = Number(r.c[1]?.v) || 0;
    if(name) paidMap[name] = monthsPaid;
  });

  let monthlyEMI = 0;
  let remaining = 0;

  emiMaster.forEach(r=>{
    const name = r.c[0]?.v;
    const totalMonths = Number(r.c[1]?.v) || 0;
    const monthlyAmt = Number(r.c[4]?.v) || 0;

    if(!name) return;

    const paid = paidMap[name] || 0;
    const remainingMonths = Math.max(totalMonths - paid, 0);

    if(remainingMonths > 0){
      monthlyEMI += monthlyAmt;
      remaining += remainingMonths * monthlyAmt;
    }
  });

  // Income from KPI sheet
  const kpiSheet = MODE === "MONTH"
    ? "Dashboard_KPIs_Month"
    : "Dashboard_KPIs_YTD";

  const kpis = await fetchSheet(kpiSheet);
  let income = 0;

  kpis.forEach(r=>{
    const k = r.c[0]?.v;
    const v = Number(r.c[1]?.v) || 0;
    if(
      (MODE === "MONTH" && k === "Current Month Income") ||
      (MODE === "YTD" && k === "YTD Income")
    ){
      income = v;
    }
  });

  const ratio = income > 0 ? monthlyEMI / income : 0;
  const pct = Math.min(ratio * 100, 100);

  document.getElementById("emiMonthly").innerText =
    "‚Çπ" + monthlyEMI.toLocaleString("en-IN");

  document.getElementById("emiRemaining").innerText =
    "‚Çπ" + remaining.toLocaleString("en-IN");

  document.getElementById("emiStressBar").style.width = pct + "%";

  const txt = document.getElementById("emiPressureText");
  if(ratio < 0.25){
    txt.innerText = "Low";
    txt.style.color = "var(--green)";
  } else if(ratio < 0.4){
    txt.innerText = "Moderate";
    txt.style.color = "var(--amber)";
  } else {
    txt.innerText = "High";
    txt.style.color = "var(--red)";
  }
}

/* Attach to reload */
const _reload7 = reloadAll;
reloadAll = function(){
  _reload7();
  loadEMIStress();
};

/* Initial load */
loadEMIStress();
</script>

   <!-- =========================================================
     ‚è≥ CASH RUNWAY & TRANSFERS
========================================================= -->
<section class="container fade">

  <div class="glass">

    <div class="h2" style="margin-bottom:8px;">Cash Runway</div>
    <div class="sub" style="margin-bottom:16px;">
      How long your cash can sustain current spending
    </div>

    <!-- SUMMARY -->
    <div style="
      display:grid;
      grid-template-columns: repeat(auto-fit,minmax(180px,1fr));
      gap:14px;
      margin-bottom:18px;
    ">
      <div>
        <div class="muted">Cash Available</div>
        <div id="cashAvailable" style="font-weight:700;font-size:18px;">‚Äî</div>
      </div>
      <div>
        <div class="muted">Daily Burn (15-day avg)</div>
        <div id="dailyBurn" style="font-weight:700;font-size:18px;">‚Äî</div>
      </div>
      <div>
        <div class="muted">Runway</div>
        <div id="runwayDays" style="font-weight:700;font-size:18px;">‚Äî</div>
      </div>
      <div>
        <div class="muted">Status</div>
        <div id="runwayStatus" style="font-weight:700;font-size:16px;">‚Äî</div>
      </div>
    </div>

    <!-- RUNWAY BAR -->
    <div style="
      position:relative;
      height:16px;
      border-radius:999px;
      overflow:hidden;
      background: rgba(255,255,255,0.08);
      border:1px solid var(--border);
      margin-bottom:12px;
    ">
      <div id="runwayBar" style="
        height:100%;
        width:0%;
        background: linear-gradient(
          90deg,
          var(--green),
          var(--amber),
          var(--red)
        );
        transition: width 1.2s var(--ease);
      "></div>
    </div>

    <!-- SMART SUGGESTION -->
    <div id="transferSuggestion" class="sub">
      ‚Äî
    </div>

  </div>

</section>

<script>
/* =========================================================
   CASH RUNWAY ‚Äî DATA LOGIC
========================================================= */
async function loadCashRunway(){

  const balances = await fetchSheet("Account_Balances_Live");
  const txns = await fetchSheet("Txn_Clean");

  let cash = 0;
  let expense15 = 0;

  // Cash balance
  balances.forEach(r=>{
    if(r.c[0]?.v === "Cash"){
      cash = Number(r.c[4]?.v) || 0;
    }
  });

  // Last 15 days expenses
  const now = new Date();
  const cutoff = new Date();
  cutoff.setDate(now.getDate() - 15);

  txns.forEach(r=>{
    const amt = Number(r.c[9]?.v) || 0;
    const dateVal = r.c[1]?.v;

    if(amt < 0 && dateVal){
      const d = new Date(dateVal);
      if(d >= cutoff){
        expense15 += Math.abs(amt);
      }
    }
  });

  const daily = expense15 / 15 || 1;
  const runway = cash / daily;

  document.getElementById("cashAvailable").innerText =
    "‚Çπ" + Math.round(cash).toLocaleString("en-IN");

  document.getElementById("dailyBurn").innerText =
    "‚Çπ" + Math.round(daily).toLocaleString("en-IN");

  document.getElementById("runwayDays").innerText =
    Math.floor(runway) + " days";

  // Status & bar
  const bar = document.getElementById("runwayBar");
  const status = document.getElementById("runwayStatus");

  const pct = Math.min((runway / 30) * 100, 100);
  bar.style.width = pct + "%";

  if(runway > 30){
    status.innerText = "Safe";
    status.style.color = "var(--green)";
  } else if(runway > 14){
    status.innerText = "Caution";
    status.style.color = "var(--amber)";
  } else {
    status.innerText = "Critical";
    status.style.color = "var(--red)";
  }

  // Smart transfer logic
  let donor = null;
  balances.forEach(r=>{
    const acc = r.c[0]?.v;
    const bal = Number(r.c[4]?.v) || 0;
    if(acc !== "Cash" && bal > 5000 && !donor){
      donor = acc;
    }
  });

  const msg = document.getElementById("transferSuggestion");
  if(runway < 14 && donor){
    msg.innerText =
      `üß† Suggested action: transfer funds from ${donor} to Cash to extend your runway.`;
  } else {
    msg.innerText =
      "Cash position is stable. No immediate transfer needed.";
  }
}

/* Attach to reload */
const _reload8 = reloadAll;
reloadAll = function(){
  _reload8();
  loadCashRunway();
};

/* Initial load */
loadCashRunway();
</script>

  <!-- =========================================================
     üß† AI INSIGHTS
========================================================= -->
<section class="container fade">

  <div class="glass">

    <div class="h2" style="margin-bottom:8px;">AI Insights</div>
    <div class="sub" style="margin-bottom:14px;">
      What your money is trying to tell you
    </div>

    <div id="aiInsights" style="
      display:flex;
      flex-direction:column;
      gap:12px;
    ">
      <!-- injected -->
    </div>

  </div>

</section>

<script>
/* =========================================================
   AI INSIGHTS ‚Äî INTELLIGENCE LAYER
========================================================= */
async function loadAIInsights(){

  const insights = [];

  /* ---------- Budget Overspend ---------- */
  const bva = await fetchSheet("Budget_vs_Actual");
  const now = new Date();
  const currentYM = now.toISOString().slice(0,7);

  let overspentCats = [];

  bva.forEach(r=>{
    const m = r.c[0]?.v;
    const cat = r.c[1]?.v;
    const budget = Number(r.c[2]?.v) || 0;
    const actual = Number(r.c[3]?.v) || 0;

    if(
      ((MODE === "MONTH" && m === currentYM) ||
       (MODE === "YTD" && m <= currentYM)) &&
      actual > budget && budget > 0
    ){
      overspentCats.push({cat, over: actual - budget});
    }
  });

  if(overspentCats.length){
    overspentCats.slice(0,2).forEach(o=>{
      insights.push({
        icon:"üö®",
        title:"Overspend Alert",
        msg:`${o.cat} exceeded budget by ‚Çπ${Math.round(o.over).toLocaleString("en-IN")}.`
      });
    });
  }

  /* ---------- Cash Runway Risk ---------- */
  const balances = await fetchSheet("Account_Balances_Live");
  let cash = 0;
  balances.forEach(r=>{
    if(r.c[0]?.v === "Cash") cash = Number(r.c[4]?.v)||0;
  });

  if(cash < 5000){
    insights.push({
      icon:"üìâ",
      title:"Low Cash Cushion",
      msg:"Cash balance is thin. Consider consolidating funds from other accounts."
    });
  }

  /* ---------- EMI Stress ---------- */
  const emiMaster = await fetchSheet("EMI_Master");
  const emiPaid = await fetchSheet("EMI_Paid_Summary");
  const paidMap = {};
  emiPaid.forEach(r=>{
    paidMap[r.c[0]?.v] = Number(r.c[1]?.v)||0;
  });

  let activeEMI = 0;
  emiMaster.forEach(r=>{
    const name = r.c[0]?.v;
    const total = Number(r.c[1]?.v)||0;
    const monthly = Number(r.c[4]?.v)||0;
    const paid = paidMap[name]||0;
    if(total-paid>0) activeEMI += monthly;
  });

  if(activeEMI > 15000){
    insights.push({
      icon:"üí≥",
      title:"High EMI Load",
      msg:"EMIs consume a large part of monthly cash flow. Avoid new liabilities."
    });
  }

  /* ---------- Positive Signal ---------- */
  const kpis = await fetchSheet(
    MODE==="MONTH" ? "Dashboard_KPIs_Month" : "Dashboard_KPIs_YTD"
  );

  let net = 0;
  kpis.forEach(r=>{
    if(
      (MODE==="MONTH" && r.c[0]?.v==="Current Month Net Savings") ||
      (MODE==="YTD" && r.c[0]?.v==="YTD Net Savings")
    ){
      net = Number(r.c[1]?.v)||0;
    }
  });

  if(net > 0){
    insights.push({
      icon:"üí°",
      title:"Healthy Momentum",
      msg:"You are saving money. This is a good phase to build reserves or invest."
    });
  }

  /* ---------- Render ---------- */
  const box = document.getElementById("aiInsights");
  box.innerHTML = "";

  if(!insights.length){
    box.innerHTML = `
      <div class="muted">
        No critical signals detected. Your finances look stable.
      </div>
    `;
    return;
  }

  insights.forEach(i=>{
    const card = document.createElement("div");
    card.style.padding = "12px 14px";
    card.style.borderRadius = "14px";
    card.style.background = "rgba(255,255,255,0.08)";
    card.style.border = "1px solid var(--border)";
    card.innerHTML = `
      <div style="font-weight:600">
        ${i.icon} ${i.title}
      </div>
      <div class="muted" style="margin-top:4px;">
        ${i.msg}
      </div>
    `;
    box.appendChild(card);
  });
}

/* Attach to reload */
const _reload9 = reloadAll;
reloadAll = function(){
  _reload9();
  loadAIInsights();
};

/* Initial load */
loadAIInsights();
</script>

   <!-- =========================================================
     üè¶ ACCOUNT BALANCES
========================================================= -->
<section class="container fade">

  <div class="glass">

    <div class="h2" style="margin-bottom:8px;">Account Balances</div>
    <div class="sub" style="margin-bottom:14px;">
      Live balances across your money buckets
    </div>

    <div style="overflow-x:auto;">
      <table style="
        width:100%;
        border-collapse:separate;
        border-spacing:0 8px;
        font-size:13px;
      ">
        <thead>
          <tr class="muted" style="text-align:left;">
            <th>Account</th>
            <th>Opening</th>
            <th>Inflows</th>
            <th>Outflows</th>
            <th>Live Balance</th>
          </tr>
        </thead>
        <tbody id="accountTable">
          <!-- injected -->
        </tbody>
      </table>
    </div>

  </div>

</section>

<script>
/* =========================================================
   ACCOUNT BALANCES ‚Äî DATA LOGIC
========================================================= */
async function loadAccountBalances(){

  const rows = await fetchSheet("Account_Balances_Live");
  const tbody = document.getElementById("accountTable");
  tbody.innerHTML = "";

  rows.forEach(r=>{
    const acc = r.c[0]?.v;
    const opening = Number(r.c[1]?.v)||0;
    const inflow = Number(r.c[2]?.v)||0;
    const outflow = Number(r.c[3]?.v)||0;
    const bal = Number(r.c[4]?.v)||0;

    if(!acc) return;

    const tr = document.createElement("tr");
    tr.style.background = "rgba(255,255,255,0.06)";
    tr.style.borderRadius = "12px";

    const risk =
      bal < 0 ? "var(--red)" :
      bal < 1500 ? "var(--amber)" :
      "var(--green)";

    tr.innerHTML = `
      <td style="padding:10px 12px;font-weight:600;">${acc}</td>
      <td>‚Çπ${opening.toLocaleString("en-IN")}</td>
      <td>‚Çπ${inflow.toLocaleString("en-IN")}</td>
      <td>‚Çπ${outflow.toLocaleString("en-IN")}</td>
      <td style="font-weight:700;color:${risk}">
        ‚Çπ${bal.toLocaleString("en-IN")}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* =========================================================
   FINAL GLOBAL RELOAD SAFETY
========================================================= */
const _reloadFinal = reloadAll;
reloadAll = function(){
  _reloadFinal();
  loadAccountBalances();
};

/* Initial */
loadAccountBalances();
</script>

<!-- =========================================================
     üì± OPTIONAL PWA INSTALL HINT
========================================================= -->
<div id="pwaHint" style="
  position:fixed;
  bottom:18px;
  right:18px;
  padding:10px 14px;
  border-radius:14px;
  background: rgba(255,255,255,0.12);
  backdrop-filter: blur(14px);
  border:1px solid var(--border);
  font-size:12px;
  display:none;
">
  üì≤ Add this dashboard to your Home Screen
</div>

<script>
/* Show PWA hint once */
if(!localStorage.getItem("pwaShown")){
  setTimeout(()=>{
    document.getElementById("pwaHint").style.display = "block";
    localStorage.setItem("pwaShown","yes");
  },4000);
}
</script>
</body>
</html>
