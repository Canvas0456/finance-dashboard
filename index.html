<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Kaiwalya ‚Ä¢ Finance Control</title>

<!-- Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Chart -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ================================
   üåó APPLE-LIKE GLOSSY THEME
================================ */

:root {
  --bg-main: #0b0f14;
  --bg-glass: rgba(255,255,255,0.08);
  --bg-glass-strong: rgba(255,255,255,0.12);
  --border-glass: rgba(255,255,255,0.18);

  --text-primary: #f9fafb;
  --text-secondary: rgba(255,255,255,0.65);
  --text-muted: rgba(255,255,255,0.4);

  --accent-blue: #5aa2ff;
  --accent-teal: #3dd6c6;
  --accent-amber: #fbbf24;
  --accent-red: #ef4444;

  --radius-xl: 26px;
  --radius-lg: 20px;
  --radius-md: 14px;

  --blur-heavy: blur(28px);
  --blur-light: blur(14px);

  --shadow-glow:
    0 0 0 rgba(0,0,0,0),
    0 20px 40px rgba(0,0,0,0.45);

  --ease-smooth: cubic-bezier(0.4, 0, 0.2, 1);
}

/* ===== RESET ===== */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html {
  scroll-behavior: smooth;
}

body {
  font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont;
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(90,162,255,0.15), transparent),
    radial-gradient(900px 500px at 90% 10%, rgba(61,214,198,0.12), transparent),
    var(--bg-main);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

/* ===== CONTAINER ===== */
.container {
  max-width: 1180px;
  margin: 0 auto;
  padding: 28px 22px;
}

/* ===== GLASS CARD ===== */
.glass {
  background: linear-gradient(
    180deg,
    rgba(255,255,255,0.14),
    rgba(255,255,255,0.05)
  );
  backdrop-filter: var(--blur-heavy);
  -webkit-backdrop-filter: var(--blur-heavy);
  border-radius: var(--radius-xl);
  border: 1px solid var(--border-glass);
  box-shadow: var(--shadow-glow);
  padding: 22px;
  position: relative;
  overflow: hidden;
  transition: transform 0.6s var(--ease-smooth),
              box-shadow 0.6s var(--ease-smooth);
}

/* subtle floating effect */
.glass:hover {
  transform: translateY(-4px) scale(1.01);
  box-shadow:
    0 30px 60px rgba(0,0,0,0.55),
    0 0 0 rgba(0,0,0,0);
}

/* ===== SHIMMER LIGHT ===== */
.glass::before {
  content: "";
  position: absolute;
  inset: -40%;
  background:
    linear-gradient(
      120deg,
      transparent 40%,
      rgba(255,255,255,0.15),
      transparent 60%
    );
  transform: translateX(-100%);
  animation: shimmer 8s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  50% { transform: translateX(100%); }
  100% { transform: translateX(100%); }
}

/* ===== TEXT STYLES ===== */
.h1 {
  font-size: 26px;
  font-weight: 700;
  letter-spacing: -0.4px;
}

.h2 {
  font-size: 18px;
  font-weight: 600;
}

.muted {
  color: var(--text-muted);
  font-size: 13px;
}

.subtle {
  color: var(--text-secondary);
  font-size: 14px;
}

/* ===== BUTTONS (iOS STYLE) ===== */
.btn {
  padding: 10px 18px;
  border-radius: 999px;
  background: rgba(255,255,255,0.12);
  backdrop-filter: var(--blur-light);
  border: 1px solid var(--border-glass);
  color: var(--text-primary);
  font-weight: 600;
  cursor: pointer;
  transition: all 0.4s var(--ease-smooth);
}

.btn.active {
  background: linear-gradient(
    135deg,
    var(--accent-blue),
    var(--accent-teal)
  );
  border-color: transparent;
  color: #fff;
}

.btn:hover {
  transform: scale(1.05);
}

/* ===== ANIMATION HELPERS ===== */
.fade-in {
  animation: fadeIn 1s var(--ease-smooth) forwards;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}

</style>
</head>

<body>

<!-- CONTENT WILL BE ADDED PART BY PART -->


<!-- ================================
     üßä HERO / TODAY PANEL
================================ -->
<header class="container fade-in">

  <div class="glass" style="
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 22px;
    align-items: center;
  ">

    <!-- LEFT: TITLE + DATE + THOUGHT -->
    <div>
      <div class="muted" id="todayDateText">‚Äî</div>

      <div class="h1" style="margin-top: 6px;">
        Finance Control Center
      </div>

      <div class="subtle" style="margin-top: 4px;">
        Calm clarity for everyday money decisions
      </div>

      <!-- Thought pill -->
      <div id="thoughtPill" style="
        margin-top: 14px;
        display: inline-block;
        padding: 10px 16px;
        border-radius: 999px;
        background: rgba(255,255,255,0.14);
        backdrop-filter: var(--blur-light);
        border: 1px solid var(--border-glass);
        font-size: 13px;
        color: var(--text-secondary);
        max-width: 100%;
      ">
        Loading today‚Äôs thought‚Ä¶
      </div>
    </div>

    <!-- RIGHT: TOGGLE -->
    <div style="
      display: flex;
      gap: 10px;
      background: rgba(255,255,255,0.08);
      padding: 6px;
      border-radius: 999px;
      backdrop-filter: var(--blur-light);
      border: 1px solid var(--border-glass);
    ">
      <button class="btn active" id="btnMonth" onclick="setMode('MONTH')">
        Month
      </button>
      <button class="btn" id="btnYTD" onclick="setMode('YTD')">
        YTD
      </button>
    </div>

  </div>

</header>

<script>
/* ===== DATE + GREETING ===== */
const today = new Date();
document.getElementById("todayDateText").innerText =
  today.toLocaleDateString("en-IN", {
    weekday: "long",
    day: "numeric",
    month: "short",
    year: "numeric"
  });

/* ===== MODE STATE ===== */
let MODE = "MONTH";

function setMode(mode){
  MODE = mode;

  const m = document.getElementById("btnMonth");
  const y = document.getElementById("btnYTD");

  if(mode === "MONTH"){
    m.classList.add("active");
    y.classList.remove("active");
  } else {
    y.classList.add("active");
    m.classList.remove("active");
  }

  // hooks for later parts
  if (typeof reloadAll === "function") {
    reloadAll();
  }
}

/* ===== THOUGHT OF THE DAY ===== */
async function loadThought(){
  const pill = document.getElementById("thoughtPill");

  try{
    const res = await fetch("https://api.quotable.io/random?tags=wisdom|inspirational");
    const data = await res.json();
    pill.innerText = `‚Äú${data.content}‚Äù`;
  }catch{
    pill.innerText = "Small calm decisions compound into financial peace.";
  }
}

loadThought();
</script>

<!-- ================================
     üí∞ MONEY POSITION STRIP
================================ -->
<section class="container fade-in" style="margin-top: 26px;">

  <div class="glass">

    <div class="h2" style="margin-bottom: 14px;">
      Money Position
    </div>

    <!-- STRIP -->
    <div style="
      display: flex;
      height: 18px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--border-glass);
    ">

      <div id="segBalance" style="
        width: 0%;
        background: linear-gradient(90deg, #5aa2ff, #3dd6c6);
        transition: width 1.4s var(--ease-smooth);
      "></div>

      <div id="segExpense" style="
        width: 0%;
        background: linear-gradient(90deg, #fbbf24, #f59e0b);
        transition: width 1.4s var(--ease-smooth);
      "></div>

      <div id="segEMI" style="
        width: 0%;
        background: linear-gradient(90deg, #ef4444, #dc2626);
        transition: width 1.4s var(--ease-smooth);
      "></div>

      <div id="segSavings" style="
        width: 0%;
        background: linear-gradient(90deg, #22c55e, #16a34a);
        transition: width 1.4s var(--ease-smooth);
      "></div>

    </div>

    <!-- LABELS -->
    <div style="
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-top: 14px;
      font-size: 13px;
    ">

      <div>
        <div class="muted">Balance</div>
        <div id="valBalance" style="font-weight:600;">‚Äî</div>
      </div>

      <div>
        <div class="muted">Expenses</div>
        <div id="valExpenses" style="font-weight:600;">‚Äî</div>
      </div>

      <div>
        <div class="muted">EMI</div>
        <div id="valEMI" style="font-weight:600;">‚Äî</div>
      </div>

      <div>
        <div class="muted">Savings</div>
        <div id="valSavings" style="font-weight:600;">‚Äî</div>
      </div>

    </div>

  </div>

</section>

<script>
/* ================================
   MONEY POSITION LOGIC
================================ */

async function loadMoneyPosition(){
  const sheet =
    MODE === "MONTH"
      ? "Dashboard_KPIs_Month"
      : "Dashboard_KPIs_YTD";

  const rows = await fetchSheet(sheet);
  const d = {};

  rows.forEach(r=>{
    if(r.c[0] && r.c[1]) d[r.c[0].v] = Number(r.c[1].v) || 0;
  });

  const balance = d["Total Balance (All Accounts)"] || 0;
  const expenses =
    MODE === "MONTH"
      ? d["Current Month Expenses"]
      : d["YTD Expenses"];

  const emi =
    MODE === "MONTH"
      ? d["EMI Paid (Current Month)"]
      : d["EMI Paid (YTD)"];

  const savings =
    MODE === "MONTH"
      ? d["Current Month Net Savings"]
      : d["YTD Net Savings"];

  const total = Math.max(balance + expenses + emi + Math.abs(savings), 1);

  /* Percentages */
  const pBal = (balance / total) * 100;
  const pExp = (expenses / total) * 100;
  const pEmi = (emi / total) * 100;
  const pSav = (Math.abs(savings) / total) * 100;

  document.getElementById("segBalance").style.width = pBal + "%";
  document.getElementById("segExpense").style.width = pExp + "%";
  document.getElementById("segEMI").style.width = pEmi + "%";
  document.getElementById("segSavings").style.width = pSav + "%";

  document.getElementById("valBalance").innerText =
    "‚Çπ" + balance.toLocaleString("en-IN");

  document.getElementById("valExpenses").innerText =
    "‚Çπ" + expenses.toLocaleString("en-IN");

  document.getElementById("valEMI").innerText =
    "‚Çπ" + emi.toLocaleString("en-IN");

  document.getElementById("valSavings").innerText =
    "‚Çπ" + savings.toLocaleString("en-IN");
}

/* Global reload hook */
function reloadAll(){
  loadMoneyPosition();
}

/* Initial */
loadMoneyPosition();
</script>

  <!-- ================================
     üìà BUDGET STORY RAIL
================================ -->
<section class="container fade-in" style="margin-top: 28px;">
  <div class="glass">

    <div class="h2" style="margin-bottom: 8px;">
      Budget Story
    </div>

    <div id="budgetNarrative" class="subtle" style="margin-bottom: 16px;">
      ‚Äî
    </div>

    <!-- Rail -->
    <div style="
      position: relative;
      height: 16px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--border-glass);
      overflow: hidden;
    ">

      <!-- Planned pace -->
      <div id="budgetPlanned" style="
        position:absolute;
        left:0;
        top:0;
        height:100%;
        width:0%;
        background: linear-gradient(90deg,#5aa2ff,#3dd6c6);
        opacity:0.35;
        transition: width 1.4s var(--ease-smooth);
      "></div>

      <!-- Actual spend -->
      <div id="budgetActual" style="
        position:absolute;
        left:0;
        top:0;
        height:100%;
        width:0%;
        background: linear-gradient(90deg,#fbbf24,#f59e0b);
        transition: width 1.4s var(--ease-smooth);
      "></div>

      <!-- Today marker -->
      <div id="todayMarker" style="
        position:absolute;
        top:-6px;
        width:2px;
        height:28px;
        background:#fff;
        opacity:0.6;
        border-radius:2px;
        left:0%;
        transition:left 1.4s var(--ease-smooth);
      "></div>

    </div>

    <!-- Numbers -->
    <div style="
      display:flex;
      justify-content:space-between;
      margin-top:12px;
      font-size:13px;
    ">
      <div class="muted">
        Planned so far: <span id="plannedVal">‚Äî</span>
      </div>
      <div class="muted">
        Actual spend: <span id="actualVal">‚Äî</span>
      </div>
    </div>

  </div>
</section>

<script>
/* ================================
   BUDGET STORY LOGIC
================================ */
async function loadBudgetStory(){
  const rows = await fetchSheet("Budget_vs_Actual");
  const now = new Date();
  const currentYM = now.toISOString().slice(0,7);

  let totalBudget = 0;
  let totalActual = 0;

  rows.forEach(r=>{
    const m = r.c[0]?.v;
    const budget = Number(r.c[2]?.v) || 0;
    const actual = Number(r.c[3]?.v) || 0;

    if(MODE === "MONTH"){
      if(m === currentYM){
        totalBudget += budget;
        totalActual += actual;
      }
    } else {
      if(m <= currentYM){
        totalBudget += budget;
        totalActual += actual;
      }
    }
  });

  /* Planned pace */
  let plannedSoFar;
  if(MODE === "MONTH"){
    const daysInMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).getDate();
    plannedSoFar = totalBudget * (now.getDate() / daysInMonth);
  } else {
    const start = new Date(now.getFullYear(), 0, 1);
    const daysPassed = (now - start) / (1000*60*60*24);
    plannedSoFar = totalBudget * (daysPassed / 365);
  }

  plannedSoFar = Math.max(plannedSoFar,1);
  const pctPlanned = Math.min((plannedSoFar / totalBudget) * 100, 100);
  const pctActual = Math.min((totalActual / totalBudget) * 100, 100);

  document.getElementById("budgetPlanned").style.width = pctPlanned + "%";
  document.getElementById("budgetActual").style.width = pctActual + "%";
  document.getElementById("todayMarker").style.left = pctPlanned + "%";

  document.getElementById("plannedVal").innerText =
    "‚Çπ" + Math.round(plannedSoFar).toLocaleString("en-IN");

  document.getElementById("actualVal").innerText =
    "‚Çπ" + Math.round(totalActual).toLocaleString("en-IN");

  /* Narrative */
  const narrative = document.getElementById("budgetNarrative");
  const diff = totalActual - plannedSoFar;

  if(diff > 0){
    narrative.innerText =
      `You are ahead of budget pace by ‚Çπ${Math.round(diff).toLocaleString("en-IN")}. Slow down discretionary spending.`;
  } else {
    narrative.innerText =
      `You are within budget pace. You have ‚Çπ${Math.round(Math.abs(diff)).toLocaleString("en-IN")} flexibility right now.`;
  }
}

/* Hook */
const prevReload2 = reloadAll;
reloadAll = function(){
  prevReload2();
  loadBudgetStory();
};

/* Initial */
loadBudgetStory();
</script>

  <!-- ================================
     üìä SPENDING BEHAVIOUR
================================ -->
<section class="container fade-in" style="margin-top: 30px;">
  <div class="glass">

    <div class="h2" style="margin-bottom: 10px;">
      Spending Behaviour
    </div>

    <div class="subtle" style="margin-bottom: 18px;">
      How your expenses are distributed through time
    </div>

    <!-- WEEKLY RHYTHM -->
    <div style="
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    " id="weeklyGrid">
      <!-- injected -->
    </div>

    <!-- MOM COMPARISON -->
    <div style="
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px,1fr));
      gap: 14px;
      font-size: 13px;
    ">
      <div>
        <div class="muted">This Month</div>
        <div id="thisMonthSpend" style="font-weight:600;">‚Äî</div>
      </div>

      <div>
        <div class="muted">Last Month</div>
        <div id="lastMonthSpend" style="font-weight:600;">‚Äî</div>
      </div>

      <div>
        <div class="muted">Direction</div>
        <div id="momDirection" style="font-weight:700;">‚Äî</div>
      </div>
    </div>

  </div>
</section>

<script>
/* ================================
   SPENDING BEHAVIOUR LOGIC
================================ */
async function loadSpendingBehaviour(){
  const rows = await fetchSheet("Txn_Clean");
  const now = new Date();

  const ym = now.toISOString().slice(0,7);
  const lastYM = new Date(now.getFullYear(), now.getMonth()-1, 1)
                    .toISOString().slice(0,7);

  /* Weekly buckets (Mon‚ÄìSun) */
  const weekSpend = [0,0,0,0,0,0,0];
  let thisMonthTotal = 0;
  let lastMonthTotal = 0;

  rows.forEach(r=>{
    const amt = Number(r.c[9]?.v) || 0;
    const m = r.c[3]?.v;
    const d = new Date(r.c[1]?.v);

    if(amt < 0){
      if(m === ym){
        thisMonthTotal += Math.abs(amt);
        const day = (d.getDay()+6)%7; // Mon=0
        weekSpend[day] += Math.abs(amt);
      }
      if(m === lastYM){
        lastMonthTotal += Math.abs(amt);
      }
    }
  });

  /* Weekly grid */
  const grid = document.getElementById("weeklyGrid");
  grid.innerHTML = "";

  const max = Math.max(...weekSpend,1);
  const days = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

  weekSpend.forEach((v,i)=>{
    const intensity = v / max;
    const cell = document.createElement("div");

    cell.style.height = "64px";
    cell.style.borderRadius = "14px";
    cell.style.display = "flex";
    cell.style.flexDirection = "column";
    cell.style.justifyContent = "center";
    cell.style.alignItems = "center";
    cell.style.fontSize = "12px";
    cell.style.background =
      `rgba(251,191,36,${0.15 + intensity*0.6})`;
    cell.style.transition = "all 0.6s var(--ease-smooth)";

    cell.innerHTML = `
      <div style="font-weight:600">${days[i]}</div>
      <div class="muted">‚Çπ${Math.round(v)}</div>
    `;

    grid.appendChild(cell);
  });

  /* MoM */
  document.getElementById("thisMonthSpend").innerText =
    "‚Çπ" + Math.round(thisMonthTotal).toLocaleString("en-IN");

  document.getElementById("lastMonthSpend").innerText =
    "‚Çπ" + Math.round(lastMonthTotal).toLocaleString("en-IN");

  const dir = document.getElementById("momDirection");
  if(thisMonthTotal > lastMonthTotal){
    dir.innerText = "‚Üë Higher spending";
    dir.style.color = "var(--accent-red)";
  } else if(thisMonthTotal < lastMonthTotal){
    dir.innerText = "‚Üì Improved control";
    dir.style.color = "var(--accent-teal)";
  } else {
    dir.innerText = "‚Üí Same level";
    dir.style.color = "var(--text-secondary)";
  }
}

/* Hook */
const prevReload3 = reloadAll;
reloadAll = function(){
  prevReload3();
  loadSpendingBehaviour();
};

/* Initial */
loadSpendingBehaviour();
</script>

  <!-- ================================
     üßæ CATEGORY RANKING
================================ -->
<section class="container fade-in" style="margin-top: 30px;">
  <div class="glass">

    <div class="h2" style="margin-bottom: 6px;">
      Expense Categories
    </div>

    <div class="subtle" style="margin-bottom: 18px;">
      Ranked by actual spending impact
    </div>

    <div id="categoryList" style="
      display: flex;
      flex-direction: column;
      gap: 10px;
    ">
      <!-- rows injected -->
    </div>

  </div>
</section>

<script>
/* ================================
   CATEGORY RANKING LOGIC
================================ */
async function loadCategoryRanking(){
  const rows = await fetchSheet("Category_Monthly_Actuals");
  const now = new Date();
  const currentYM = now.toISOString().slice(0,7);

  const data = {};
  rows.forEach(r=>{
    const m = r.c[0]?.v;
    const cat = r.c[1]?.v;
    const amt = Number(r.c[2]?.v) || 0;

    if(!cat) return;

    if(MODE === "MONTH"){
      if(m === currentYM){
        data[cat] = (data[cat] || 0) + amt;
      }
    } else {
      if(m <= currentYM){
        data[cat] = (data[cat] || 0) + amt;
      }
    }
  });

  const sorted = Object.entries(data)
    .sort((a,b)=>b[1]-a[1]);

  const list = document.getElementById("categoryList");
  list.innerHTML = "";

  const total = sorted.reduce((s,[,v])=>s+v,0) || 1;

  sorted.forEach(([cat,amt],i)=>{
    const pct = Math.round((amt/total)*100);

    const row = document.createElement("div");
    row.style.display = "grid";
    row.style.gridTemplateColumns = "1fr auto auto";
    row.style.alignItems = "center";
    row.style.gap = "12px";
    row.style.padding = "10px 14px";
    row.style.borderRadius = "14px";
    row.style.background = "rgba(255,255,255,0.08)";
    row.style.border = "1px solid var(--border-glass)";

    row.innerHTML = `
      <div>
        <div style="font-weight:600">${cat}</div>
        <div class="muted">${pct}% of spend</div>
      </div>
      <div style="font-weight:600">
        ‚Çπ${Math.round(amt).toLocaleString("en-IN")}
      </div>
      <div style="font-size:14px;color:var(--text-muted)">
        #${i+1}
      </div>
    `;

    list.appendChild(row);
  });
}

/* Hook */
const prevReload4 = reloadAll;
reloadAll = function(){
  prevReload4();
  loadCategoryRanking();
};

/* Initial */
loadCategoryRanking();
  </script>



 <!-- ================================
     üí≥ EMI & OBLIGATIONS
================================ -->
<section class="container fade-in" style="margin-top: 32px;">
  <div class="glass">

    <div class="h2" style="margin-bottom: 6px;">
      EMI & Obligations
    </div>

    <div class="subtle" style="margin-bottom: 18px;">
      Ongoing commitments and financial pressure
    </div>

    <!-- EMI SUMMARY -->
    <div style="
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(200px,1fr));
      gap: 16px;
      margin-bottom: 18px;
    ">

      <div>
        <div class="muted">Monthly EMI Outflow</div>
        <div id="emiMonthly" style="font-weight:700;font-size:18px;">‚Äî</div>
      </div>

      <div>
        <div class="muted">Remaining EMI Liability</div>
        <div id="emiRemaining" style="font-weight:700;font-size:18px;">‚Äî</div>
      </div>

      <div>
        <div class="muted">EMI Stress Level</div>
        <div id="emiStatus" style="font-weight:700;font-size:16px;">‚Äî</div>
      </div>

    </div>

    <!-- STRESS THERMOMETER -->
    <div style="
      position: relative;
      height: 16px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--border-glass);
      overflow: hidden;
    ">

      <div id="emiStressBar" style="
        height:100%;
        width:0%;
        transition: width 1.4s var(--ease-smooth);
        background: linear-gradient(90deg,
          #22c55e,
          #fbbf24,
          #ef4444
        );
      "></div>

    </div>

    <div class="muted" style="margin-top:10px;font-size:12px;">
      Green = manageable ¬∑ Amber = caution ¬∑ Red = high pressure
    </div>

  </div>
</section>

<script>
/* ================================
   EMI LOGIC
================================ */
async function loadEMIZone(){
  const master = await fetchSheet("EMI_Master");
  const paid = await fetchSheet("EMI_Paid_Summary");

  let monthlyEMI = 0;
  let remaining = 0;

  const paidMap = {};
  paid.forEach(r=>{
    const name = r.c[0]?.v;
    const monthsPaid = Number(r.c[1]?.v) || 0;
    paidMap[name] = monthsPaid;
  });

  master.forEach(r=>{
    const name = r.c[0]?.v;
    const totalMonths = Number(r.c[1]?.v) || 0;
    const monthlyAmt = Number(r.c[4]?.v) || 0;

    if(!name) return;

    const paidMonths = paidMap[name] || 0;
    const remainingMonths = Math.max(totalMonths - paidMonths, 0);

    if(remainingMonths > 0){
      monthlyEMI += monthlyAmt;
      remaining += remainingMonths * monthlyAmt;
    }
  });

  document.getElementById("emiMonthly").innerText =
    "‚Çπ" + Math.round(monthlyEMI).toLocaleString("en-IN");

  document.getElementById("emiRemaining").innerText =
    "‚Çπ" + Math.round(remaining).toLocaleString("en-IN");

  /* Stress logic */
  const kpiSheet =
    MODE === "MONTH"
      ? "Dashboard_KPIs_Month"
      : "Dashboard_KPIs_YTD";

  const kpi = await fetchSheet(kpiSheet);
  let income = 0;

  kpi.forEach(r=>{
    if(r.c[0]?.v === "Current Month Income" ||
       r.c[0]?.v === "YTD Income"){
      income = Number(r.c[1]?.v) || 0;
    }
  });

  const ratio = income > 0 ? monthlyEMI / income : 0;
  const bar = document.getElementById("emiStressBar");
  const status = document.getElementById("emiStatus");

  const pct = Math.min(ratio * 100, 100);
  bar.style.width = pct + "%";

  if(ratio < 0.25){
    status.innerText = "Low pressure";
    status.style.color = "var(--accent-teal)";
  } else if(ratio < 0.45){
    status.innerText = "Moderate pressure";
    status.style.color = "var(--accent-amber)";
  } else {
    status.innerText = "High pressure";
    status.style.color = "var(--accent-red)";
  }
}

/* Hook */
const prevReload5 = reloadAll;
reloadAll = function(){
  prevReload5();
  loadEMIZone();
};

/* Initial */
loadEMIZone();
</script>


  <!-- ================================
     ‚è≥ CASH RUNWAY & TRANSFERS
================================ -->
<section class="container fade-in" style="margin-top: 34px;">
  <div class="glass">

    <div class="h2" style="margin-bottom: 6px;">
      Cash Runway
    </div>

    <div class="subtle" style="margin-bottom: 18px;">
      How long your current cash can sustain daily expenses
    </div>

    <!-- RUNWAY SUMMARY -->
    <div style="
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(180px,1fr));
      gap:16px;
      margin-bottom:18px;
    ">
      <div>
        <div class="muted">Available Cash</div>
        <div id="cashAvailable" style="font-size:20px;font-weight:700;">‚Äî</div>
      </div>

      <div>
        <div class="muted">Daily Burn (15-day avg)</div>
        <div id="dailyBurn" style="font-size:20px;font-weight:700;">‚Äî</div>
      </div>

      <div>
        <div class="muted">Runway</div>
        <div id="runwayDays" style="font-size:20px;font-weight:700;">‚Äî</div>
      </div>

      <div>
        <div class="muted">Status</div>
        <div id="runwayStatus" style="font-size:16px;font-weight:700;">‚Äî</div>
      </div>
    </div>

    <!-- RUNWAY BAR -->
    <div style="
      position: relative;
      height: 14px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      border: 1px solid var(--border-glass);
      overflow: hidden;
      margin-bottom:14px;
    ">
      <div id="runwayBar" style="
        height:100%;
        width:0%;
        transition: width 1.4s var(--ease-smooth);
        background: linear-gradient(90deg,#22c55e,#fbbf24,#ef4444);
      "></div>
    </div>

    <!-- SMART TRANSFER -->
    <div id="transferSuggestion" style="
      margin-top:10px;
      font-size:13px;
      color: var(--text-secondary);
    ">
      ‚Äî
    </div>

  </div>
</section>

<script>
/* ================================
   CASH RUNWAY LOGIC
================================ */
async function loadCashRunway(){
  const balances = await fetchSheet("Account_Balances_Live");
  const txns = await fetchSheet("Txn_Clean");

  let cash = 0;
  let expense15d = 0;

  /* Cash in hand */
  balances.forEach(r=>{
    if(r.c[0]?.v === "Cash"){
      cash = Number(r.c[4]?.v) || 0;
    }
  });

  /* Last 15 days expenses */
  const now = new Date();
  const cutoff = new Date(now);
  cutoff.setDate(now.getDate() - 15);

  txns.forEach(r=>{
    const amt = Number(r.c[9]?.v) || 0;
    const date = new Date(r.c[1]?.v);
    if(amt < 0 && date >= cutoff){
      expense15d += Math.abs(amt);
    }
  });

  const daily = expense15d / 15 || 1;
  const runway = cash / daily;

  document.getElementById("cashAvailable").innerText =
    "‚Çπ" + Math.round(cash).toLocaleString("en-IN");

  document.getElementById("dailyBurn").innerText =
    "‚Çπ" + Math.round(daily).toLocaleString("en-IN");

  document.getElementById("runwayDays").innerText =
    Math.floor(runway) + " days";

  /* Status */
  const bar = document.getElementById("runwayBar");
  const status = document.getElementById("runwayStatus");

  const pct = Math.min((runway / 30) * 100, 100);
  bar.style.width = pct + "%";

  if(runway > 30){
    status.innerText = "Safe";
    status.style.color = "var(--accent-teal)";
  } else if(runway > 14){
    status.innerText = "Caution";
    status.style.color = "var(--accent-amber)";
  } else {
    status.innerText = "Critical";
    status.style.color = "var(--accent-red)";
  }

  /* Smart transfer */
  let donor = null;
  balances.forEach(r=>{
    const name = r.c[0]?.v;
    const bal = Number(r.c[4]?.v) || 0;
    if(name !== "Cash" && bal > 5000){
      donor = name;
    }
  });

  const msg = document.getElementById("transferSuggestion");
  if(runway < 14 && donor){
    msg.innerText =
      `üß† Consider transferring funds from ${donor} to Cash to extend your runway.`;
  } else {
    msg.innerText =
      "Cash position is currently stable. No immediate action needed.";
  }
}

/* Hook */
const prevReload6 = reloadAll;
reloadAll = function(){
  prevReload6();
  loadCashRunway();
};

/* Initial */
loadCashRunway();
    </script>

<!-- ================================
     üß† AI INSIGHTS
================================ -->
<section class="container fade-in" style="margin-top: 36px;">
  <div class="glass">

    <div class="h2" style="margin-bottom: 6px;">
      Insights
    </div>

    <div class="subtle" style="margin-bottom: 18px;">
      What deserves your attention right now
    </div>

    <div id="insightsList" style="
      display:flex;
      flex-direction:column;
      gap:12px;
    ">
      <!-- insights injected -->
    </div>

  </div>
</section>

<script>
/* ================================
   AI INSIGHTS ENGINE
================================ */
async function loadAIInsights(){
  const insights = [];

  /* ---------- DATA SOURCES ---------- */
  const kpiSheet =
    MODE === "MONTH"
      ? "Dashboard_KPIs_Month"
      : "Dashboard_KPIs_YTD";

  const kpis = await fetchSheet(kpiSheet);
  const balances = await fetchSheet("Account_Balances_Live");
  const budget = await fetchSheet("Budget_vs_Actual");

  let k = {};
  kpis.forEach(r=>{
    if(r.c[0]?.v) k[r.c[0].v] = Number(r.c[1]?.v) || 0;
  });

  /* ---------- 1. OVESPEND ALERT ---------- */
  let budgetUsed = 0;
  let budgetTotal = 0;

  const nowYM = new Date().toISOString().slice(0,7);

  budget.forEach(r=>{
    const m = r.c[0]?.v;
    if(
      (MODE === "MONTH" && m === nowYM) ||
      (MODE === "YTD" && m <= nowYM)
    ){
      budgetTotal += Number(r.c[2]?.v) || 0;
      budgetUsed += Number(r.c[3]?.v) || 0;
    }
  });

  const burnPct = budgetTotal > 0 ? budgetUsed / budgetTotal : 0;

  if(burnPct > 0.9){
    insights.push({
      type:"Overspend",
      severity:"HIGH",
      title:"Budget burn is high",
      msg:`You have used ${Math.round(burnPct*100)}% of your budget.`,
      action:"Pause discretionary categories for a few days.",
      confidence:0.95
    });
  } else if(burnPct > 0.75){
    insights.push({
      type:"Overspend",
      severity:"MEDIUM",
      title:"Budget pace needs attention",
      msg:`You are at ${Math.round(burnPct*100)}% budget usage.`,
      action:"Track food, travel and shopping closely.",
      confidence:0.85
    });
  }

  /* ---------- 2. CASH RUNWAY ALERT ---------- */
  let cash = 0;
  balances.forEach(r=>{
    if(r.c[0]?.v === "Cash"){
      cash = Number(r.c[4]?.v) || 0;
    }
  });

  const dailyBurn =
    MODE === "MONTH"
      ? k["Current Month Expenses"] / new Date().getDate()
      : k["YTD Expenses"] / (new Date().getMonth()*30+1);

  const runway = cash / (dailyBurn || 1);

  if(runway < 10){
    insights.push({
      type:"Cash",
      severity:"HIGH",
      title:"Cash runway is critical",
      msg:`Cash may last only ${Math.floor(runway)} days at current spend.`,
      action:"Move funds into Cash or reduce daily expenses.",
      confidence:0.9
    });
  } else if(runway < 20){
    insights.push({
      type:"Cash",
      severity:"MEDIUM",
      title:"Cash runway is tightening",
      msg:`Estimated runway is ${Math.floor(runway)} days.`,
      action:"Avoid non-essential spends this week.",
      confidence:0.75
    });
  }

  /* ---------- 3. EMI PRESSURE ---------- */
  const emiMonthly = k["EMI Paid (Current Month)"] || 0;
  const income =
    MODE === "MONTH"
      ? k["Current Month Income"]
      : k["YTD Income"];

  if(income > 0 && emiMonthly / income > 0.4){
    insights.push({
      type:"EMI",
      severity:"HIGH",
      title:"EMI pressure is heavy",
      msg:"EMIs consume a large portion of income.",
      action:"Avoid new obligations and build buffer.",
      confidence:0.88
    });
  }

  /* ---------- 4. POSITIVE INSIGHT ---------- */
  const savings =
    MODE === "MONTH"
      ? k["Current Month Net Savings"]
      : k["YTD Net Savings"];

  if(savings > 0 && burnPct < 0.7){
    insights.push({
      type:"Opportunity",
      severity:"LOW",
      title:"You are in a healthy zone",
      msg:"Savings and budget are well balanced.",
      action:"Consider investing surplus safely.",
      confidence:0.8
    });
  }

  /* ---------- RENDER ---------- */
  const list = document.getElementById("insightsList");
  list.innerHTML = "";

  if(insights.length === 0){
    list.innerHTML = `
      <div class="subtle">
        No critical insights right now. Keep going üëç
      </div>`;
    return;
  }

  insights
    .sort((a,b)=>b.confidence - a.confidence)
    .forEach(i=>{
      const card = document.createElement("div");

      let color =
        i.severity === "HIGH"
          ? "var(--accent-red)"
          : i.severity === "MEDIUM"
          ? "var(--accent-amber)"
          : "var(--accent-teal)";

      card.style.padding = "14px 16px";
      card.style.borderRadius = "16px";
      card.style.background = "rgba(255,255,255,0.08)";
      card.style.border = `1px solid ${color}`;
      card.style.display = "grid";
      card.style.gap = "6px";

      card.innerHTML = `
        <div style="font-weight:700;color:${color}">
          ${i.title}
        </div>
        <div class="subtle">${i.msg}</div>
        <div style="font-size:13px;">
          üëâ ${i.action}
        </div>
        <div class="muted" style="font-size:11px;">
          Confidence: ${Math.round(i.confidence*100)}%
        </div>
      `;

      list.appendChild(card);
    });
}

/* Hook */
const prevReload7 = reloadAll;
reloadAll = function(){
  prevReload7();
  loadAIInsights();
};

/* Initial */
loadAIInsights();
</script>

 <!-- ================================
     üéØ ACTIONS & SYSTEM POLISH
================================ -->
<section class="container fade-in" style="margin-top: 38px; margin-bottom: 60px;">
  <div class="glass">

    <div class="h2" style="margin-bottom: 6px;">
      Suggested Actions
    </div>

    <div class="subtle" style="margin-bottom: 18px;">
      Small actions that improve financial stability
    </div>

    <div id="actionsList" style="
      display:flex;
      flex-direction:column;
      gap:12px;
    ">
      <!-- actions injected -->
    </div>

  </div>
</section>

<!-- ================================
     üì± PWA INSTALL PROMPT
================================ -->
<div id="pwaPrompt" style="
  position: fixed;
  bottom: 18px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.12);
  backdrop-filter: var(--blur-light);
  border: 1px solid var(--border-glass);
  padding: 14px 18px;
  border-radius: 18px;
  display: none;
  gap: 12px;
  align-items: center;
  z-index: 999;
">
  <div class="subtle">
    Install this dashboard for quick access
  </div>
  <button class="btn" onclick="installPWA()">Install</button>
</div>

<script>
/* ================================
   ACTIONS ENGINE
================================ */
async function loadActions(){
  const actions = [];

  const kpiSheet =
    MODE === "MONTH"
      ? "Dashboard_KPIs_Month"
      : "Dashboard_KPIs_YTD";

  const kpis = await fetchSheet(kpiSheet);
  const balances = await fetchSheet("Account_Balances_Live");

  let k = {};
  kpis.forEach(r=>{
    if(r.c[0]?.v) k[r.c[0].v] = Number(r.c[1]?.v) || 0;
  });

  /* Low balance actions */
  balances.forEach(r=>{
    const acc = r.c[0]?.v;
    const bal = Number(r.c[4]?.v) || 0;
    const safe = Number(r.c[5]?.v) || 0;

    if(acc && safe && bal < safe){
      actions.push(
        `Top up <b>${acc}</b> to maintain safe balance`
      );
    }
  });

  /* Savings action */
  const savings =
    MODE === "MONTH"
      ? k["Current Month Net Savings"]
      : k["YTD Net Savings"];

  if(savings > 3000){
    actions.push(
      "Consider parking surplus into short-term investment"
    );
  }

  /* Budget action */
  if(k["Budget Used %"] > 0.85){
    actions.push(
      "Avoid discretionary categories for the rest of the period"
    );
  }

  /* Render */
  const list = document.getElementById("actionsList");
  list.innerHTML = "";

  if(actions.length === 0){
    list.innerHTML = `
      <div class="subtle">
        No immediate actions required. You‚Äôre in control üëç
      </div>`;
    return;
  }

  actions.forEach(a=>{
    const row = document.createElement("div");
    row.style.padding = "12px 16px";
    row.style.borderRadius = "14px";
    row.style.background = "rgba(255,255,255,0.08)";
    row.style.border = "1px solid var(--border-glass)";
    row.innerHTML = "üëâ " + a;
    list.appendChild(row);
  });
}

/* ================================
   PWA INSTALL SUPPORT
================================ */
let deferredPrompt = null;

window.addEventListener("beforeinstallprompt", (e)=>{
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById("pwaPrompt").style.display = "flex";
});

function installPWA(){
  if(!deferredPrompt) return;
  deferredPrompt.prompt();
  deferredPrompt.userChoice.finally(()=>{
    deferredPrompt = null;
    document.getElementById("pwaPrompt").style.display = "none";
  });
}

/* ================================
   SAFETY GUARDS
================================ */
async function fetchSheetSafe(name){
  try{
    return await fetchSheet(name);
  }catch{
    console.warn("Sheet missing:", name);
    return [];
  }
}

/* ================================
   FINAL HOOK
================================ */
const prevReloadFinal = reloadAll;
reloadAll = function(){
  prevReloadFinal();
  loadActions();
};

/* Initial */
loadActions();
      </script>

  

</body>
</html>
